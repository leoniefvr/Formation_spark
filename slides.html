<!DOCTYPE html>
<html lang="en"><head>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-html/tabby.min.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/light-border.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-html.min.css" rel="stylesheet" data-mode="light">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles"><meta charset="utf-8">
  <meta name="generator" content="quarto-1.5.57">

  <title>Formation sparklyr – Initiation à Spark avec R en mode cluster</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reset.css">
  <link rel="stylesheet" href="site_libs/revealjs/dist/reveal.css">
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      { color: #003b4f; background-color: #f1f3f5; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span { color: #003b4f; } /* Normal */
    code span.al { color: #ad0000; } /* Alert */
    code span.an { color: #5e5e5e; } /* Annotation */
    code span.at { color: #657422; } /* Attribute */
    code span.bn { color: #ad0000; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #003b4f; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #20794d; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #5e5e5e; } /* Comment */
    code span.cv { color: #5e5e5e; font-style: italic; } /* CommentVar */
    code span.do { color: #5e5e5e; font-style: italic; } /* Documentation */
    code span.dt { color: #ad0000; } /* DataType */
    code span.dv { color: #ad0000; } /* DecVal */
    code span.er { color: #ad0000; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #ad0000; } /* Float */
    code span.fu { color: #4758ab; } /* Function */
    code span.im { color: #00769e; } /* Import */
    code span.in { color: #5e5e5e; } /* Information */
    code span.kw { color: #003b4f; font-weight: bold; } /* Keyword */
    code span.op { color: #5e5e5e; } /* Operator */
    code span.ot { color: #003b4f; } /* Other */
    code span.pp { color: #ad0000; } /* Preprocessor */
    code span.sc { color: #5e5e5e; } /* SpecialChar */
    code span.ss { color: #20794d; } /* SpecialString */
    code span.st { color: #20794d; } /* String */
    code span.va { color: #111111; } /* Variable */
    code span.vs { color: #20794d; } /* VerbatimString */
    code span.wa { color: #5e5e5e; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="site_libs/revealjs/dist/theme/quarto.css">
  <link href="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/reveal-menu/quarto-menu.css" rel="stylesheet">
  <link href="site_libs/revealjs/plugin/quarto-support/footer.css" rel="stylesheet">
  <style type="text/css">

  .callout {
    margin-top: 1em;
    margin-bottom: 1em;  
    border-radius: .25rem;
  }

  .callout.callout-style-simple { 
    padding: 0em 0.5em;
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
    display: flex;
  }

  .callout.callout-style-default {
    border-left: solid #acacac .3rem;
    border-right: solid 1px silver;
    border-top: solid 1px silver;
    border-bottom: solid 1px silver;
  }

  .callout .callout-body-container {
    flex-grow: 1;
  }

  .callout.callout-style-simple .callout-body {
    font-size: 1rem;
    font-weight: 400;
  }

  .callout.callout-style-default .callout-body {
    font-size: 0.9rem;
    font-weight: 400;
  }

  .callout.callout-titled.callout-style-simple .callout-body {
    margin-top: 0.2em;
  }

  .callout:not(.callout-titled) .callout-body {
      display: flex;
  }

  .callout:not(.no-icon).callout-titled.callout-style-simple .callout-content {
    padding-left: 1.6em;
  }

  .callout.callout-titled .callout-header {
    padding-top: 0.2em;
    margin-bottom: -0.2em;
  }

  .callout.callout-titled .callout-title  p {
    margin-top: 0.5em;
    margin-bottom: 0.5em;
  }
    
  .callout.callout-titled.callout-style-simple .callout-content  p {
    margin-top: 0;
  }

  .callout.callout-titled.callout-style-default .callout-content  p {
    margin-top: 0.7em;
  }

  .callout.callout-style-simple div.callout-title {
    border-bottom: none;
    font-size: .9rem;
    font-weight: 600;
    opacity: 75%;
  }

  .callout.callout-style-default  div.callout-title {
    border-bottom: none;
    font-weight: 600;
    opacity: 85%;
    font-size: 0.9rem;
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-default div.callout-content {
    padding-left: 0.5em;
    padding-right: 0.5em;
  }

  .callout.callout-style-simple .callout-icon::before {
    height: 1rem;
    width: 1rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 1rem 1rem;
  }

  .callout.callout-style-default .callout-icon::before {
    height: 0.9rem;
    width: 0.9rem;
    display: inline-block;
    content: "";
    background-repeat: no-repeat;
    background-size: 0.9rem 0.9rem;
  }

  .callout-title {
    display: flex
  }
    
  .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  .callout.no-icon::before {
    display: none !important;
  }

  .callout.callout-titled .callout-body > .callout-content > :last-child {
    padding-bottom: 0.5rem;
    margin-bottom: 0;
  }

  .callout.callout-titled .callout-icon::before {
    margin-top: .5rem;
    padding-right: .5rem;
  }

  .callout:not(.callout-titled) .callout-icon::before {
    margin-top: 1rem;
    padding-right: .5rem;
  }

  /* Callout Types */

  div.callout-note {
    border-left-color: #4582ec !important;
  }

  div.callout-note .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEU0lEQVRYCcVXTWhcVRQ+586kSUMMxkyaElstCto2SIhitS5Ek8xUKV2poatCcVHtUlFQk8mbaaziwpWgglJwVaquitBOfhQXFlqlzSJpFSpIYyXNjBNiTCck7x2/8/LeNDOZxDuEkgOXe++553zfefee+/OYLOXFk3+1LLrRdiO81yNqZ6K9cG0P3MeFaMIQjXssE8Z1JzLO9ls20MBZX7oG8w9GxB0goaPrW5aNMp1yOZIa7Wv6o2ykpLtmAPs/vrG14Z+6d4jpbSKuhdcSyq9wGMPXjonwmESXrriLzFGOdDBLB8Y6MNYBu0dRokSygMA/mrun8MGFN3behm6VVAwg4WR3i6FvYK1T7MHo9BK7ydH+1uurECoouk5MPRyVSBrBHMYwVobG2aOXM07sWrn5qgB60rc6mcwIDJtQrnrEr44kmy+UO9r0u9O5/YbkS9juQckLed3DyW2XV/qWBBB3ptvI8EUY3I9p/67OW+g967TNr3Sotn3IuVlfMLVnsBwH4fsnebJvyGm5GeIUA3jljERmrv49SizPYuq+z7c2H/jlGC+Ghhupn/hcapqmcudB9jwJ/3jvnvu6vu5lVzF1fXyZuZZ7U8nRmVzytvT+H3kilYvH09mLWrQdwFSsFEsxFVs5fK7A0g8gMZjbif4ACpKbjv7gNGaD8bUrlk8x+KRflttr22JEMRUbTUwwDQScyzPgedQHZT0xnx7ujw2jfVfExwYHwOsDTjLdJ2ebmeQIlJ7neo41s/DrsL3kl+W2lWvAga0tR3zueGr6GL78M3ifH0rGXrBC2aAR8uYcIA5gwV8zIE8onoh8u0Fca/ciF7j1uOzEnqcIm59sEXoGc0+z6+H45V1CvAvHcD7THztu669cnp+L0okAeIc6zjbM/24LgGM1gZk7jnRu1aQWoU9sfUOuhrmtaPIO3YY1KLLWZaEO5TKUbMY5zx8W9UJ6elpLwKXbsaZ4EFl7B4bMtDv0iRipKoDQT2sNQI9b1utXFdYisi+wzZ/ri/1m7QfDgEuvgUUEIJPq3DhX/5DWNqIXDOweC2wvIR90Oq3lDpdMIgD2r0dXvGdsEW5H6x6HLRJYU7C69VefO1x8Gde1ZFSJLfWS1jbCnhtOPxmpfv2LXOA2Xk2tvnwKKPFuZ/oRmwBwqRQDcKNeVQkYcOjtWVBuM/JuYw5b6isojIkYxyYAFn5K7ZBF10fea52y8QltAg6jnMqNHFBmGkQ1j+U43HMi2xMar1Nv0zGsf1s8nUsmUtPOOrbFIR8bHFDMB5zL13Gmr/kGlCkUzedTzzmzsaJXhYawnA3UmARpiYj5ooJZiUoxFRtK3X6pgNPv+IZVPcnwbOl6f+aBaO1CNvPW9n9LmCp01nuSaTRF2YxHqZ8DYQT6WsXT+RD6eUztwYLZ8rM+rcPxamv1VQzFUkzFXvkiVrySGQgJNvXHJAxiU3/NwiC03rSf05VBaPtu/Z7/B8Yn/w7eguloAAAAAElFTkSuQmCC');
  }

  div.callout-note.callout-style-default .callout-title {
    background-color: #dae6fb
  }

  div.callout-important {
    border-left-color: #d9534f !important;
  }

  div.callout-important .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAEKklEQVRYCcVXTWhcVRS+575MJym48A+hSRFr00ySRQhURRfd2HYjk2SSTokuBCkU2o0LoSKKraKIBTcuFCoidGFD08nkBzdREbpQ1EDNIv8qSGMFUboImMSZd4/f9zJv8ibJMC8xJQfO3HPPPef7zrvvvnvviIkpC9nsw0UttFunbUhpFzFtarSd6WJkStVMw5xyVqYTvkwfzuf/5FgtkVoB0729j1rjXwThS7Vio+Mo6DNnvLfahoZ+i/o32lULuJ3NNiz7q6+pyAUkJaFF6JwaM2lUJlV0MlnQn5aTRbEu0SEqHUa0A4AdiGuB1kFXRfVyg5d87+Dg4DL6m2TLAub60ilj7A1Ec4odSAc8X95sHh7+ZRPCFo6Fnp7HfU/fBng/hi10CjCnWnJjsxvDNxWw0NfV6Rv5GgP3I3jGWXumdTD/3cbEOP2ZbOZp69yniG3FQ9z1jD7bnBu9Fc2tKGC2q+uAJOQHBDRiZX1x36o7fWBs7J9ownbtO+n0/qWkvW7UPIfc37WgT6ZGR++EOJyeQDSb9UB+DZ1G6DdLDzyS+b/kBCYGsYgJbSQHuThGKRcw5xdeQf8YdNHsc6ePXrlSYMBuSIAFTGAtQo+VuALo4BX83N190NWZWbynBjhOHsmNfFWLeL6v+ynsA58zDvvAC8j5PkbOcXCMg2PZFk3q8MjI7WAG/Dp9AwP7jdGBOOQkAvlFUB+irtm16I1Zw9YBcpGTGXYmk3kQIC/Cds55l+iMI3jqhjAuaoe+am2Jw5GT3Nbz3CkE12NavmzN5+erJW7046n/CH1RO/RVa8lBLozXk9uqykkGAyRXLWlLv5jyp4RFsG5vGVzpDLnIjTWgnRy2Rr+tDKvRc7Y8AyZq10jj8DqXdnIRNtFZb+t/ZRtXcDiVnzpqx8mPcDWxgARUqx0W1QB9MeUZiNrV4qP+Ehc+BpNgATsTX8ozYKL2NtFYAHc84fG7ndxUPr+AR/iQSns7uSUufAymwDOb2+NjK27lEFocm/EE2WpyIy/Hi66MWuMKJn8RvxIcj87IM5Vh9663ziW36kR0HNenXuxmfaD8JC7tfKbrhFr7LiZCrMjrzTeGx+PmkosrkNzW94ObzwocJ7A1HokLolY+AvkTiD/q1H0cN48c5EL8Crkttsa/AXQVDmutfyku0E7jShx49XqV3MFK8IryDhYVbj7Sj2P2eBxwcXoe8T8idsKKPRcnZw1b+slFTubwUwhktrfnAt7J++jwQtLZcm3sr9LQrjRzz6cfMv9aLvgmnAGvpoaGLxM4mAEaLV7iAzQ3oU0IvD5x9ix3yF2RAAuYAOO2f7PEFWCXZ4C9Pb2UsgDeVnFSpbFK7/IWu7TPTvBqzbGdCHOJQSxiEjt6IyZmxQyEJHv6xyQsYk//moVFsN2zP6fRImjfq7/n/wFDguUQFNEwugAAAABJRU5ErkJggg==');
  }

  div.callout-important.callout-style-default .callout-title {
    background-color: #f7dddc
  }

  div.callout-warning {
    border-left-color: #f0ad4e !important;
  }

  div.callout-warning .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAAETklEQVRYCeVWW2gcVRg+58yaTUnizqbipZeX4uWhBEniBaoUX1Ioze52t7sRq6APio9V9MEaoWlVsFasRq0gltaAPuxms8lu0gcviE/FFOstVbSIxgcv6SU7EZqmdc7v9+9mJtNks51NTUH84ed889/PP+cmxP+d5FIbMJmNbpREu4WUkiTtCicKny0l1pIKmBzovF2S+hIJHX8iEu3hZJ5lNZGqyRrGSIQpq15AzF28jgpeY6yk6GVdrfFqdrD6Iw+QlB8g0YS2g7dyQmXM/IDhBhT0UCiRf59lfqmmDvzRt6kByV/m4JjtzuaujMUM2c5Z2d6JdKrRb3K2q6mA+oYVz8JnDdKPmmNthzkAk/lN63sYPgevrguc72aZX/L9C6x09GYyxBgCX4NlvyGUHOKELlm5rXeR1kchuChJt4SSwyddZRXgvwMGvYo4QSlk3/zkHD8UHxwVJA6zjZZqP8v8kK8OWLnIZtLyCAJagYC4rTGW/9Pqj92N/c+LUaAj27movwbi19tk/whRCIE7Q9vyI6yvRpftAKVTdUjOW40X3h5OXsKCdmFcx0xlLJoSuQngnrJe7Kcjm4OMq9FlC7CMmScQANuNvjfP3PjGXDBaUQmbp296S5L4DrpbrHN1T87ZVEZVCzg1FF0Ft+dKrlLukI+/c9ENo+TvlTDbYFvuKPtQ9+l052rXrgKoWkDAFnvh0wTOmYn8R5f4k/jN/fZiCM1tQx9jQQ4ANhqG4hiL0qIFTGViG9DKB7GYzgubnpofgYRwO+DFjh0Zin2m4b/97EDkXkc+f6xYAPX0KK2I/7fUQuwzuwo/L3AkcjugPNixC8cHf0FyPjWlItmLxWw4Ou9YsQCr5fijMGoD/zpdRy95HRysyXA74MWOnscpO4j2y3HAVisw85hX5+AFBRSHt4ShfLFkIMXTqyKFc46xdzQM6XbAi702a7sy04J0+feReMFKp5q9esYLCqAZYw/k14E/xcLLsFElaornTuJB0svMuJINy8xkIYuL+xPAlWRceH6+HX7THJ0djLUom46zREu7tTkxwmf/FdOZ/sh6Q8qvEAiHpm4PJ4a/doJe0gH1t+aHRgCzOvBvJedEK5OFE5jpm4AGP2a8Dxe3gGJ/pAutug9Gp6he92CsSsWBaEcxGx0FHytmIpuqGkOpldqNYQK8cSoXvd+xLxXADw0kf6UkJNFtdo5MOgaLjiQOQHcn+A6h5NuL2s0qsC2LOM75PcF3yr5STuBSAcGG+meA14K/CI21HcS4LBT6tv0QAh8Dr5l93AhZzG5ZJ4VxAqdZUEl9z7WJ4aN+svMvwHHL21UKTd1mqvChH7/Za5xzXBBKrUcB0TQ+Ulgkfbi/H/YT5EptrGzsEK7tR1B7ln9BBwckYfMiuSqklSznIuoIIOM42MQO+QnduCoFCI0bpkzjCjddHPN/F+2Yu+sd9bKNpVwHhbS3LluK/0zgfwD0xYI5dXuzlQAAAABJRU5ErkJggg==');
  }

  div.callout-warning.callout-style-default .callout-title {
    background-color: #fcefdc
  }

  div.callout-tip {
    border-left-color: #02b875 !important;
  }

  div.callout-tip .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAADr0lEQVRYCe1XTWgTQRj9ZjZV8a9SPIkKgj8I1bMHsUWrqYLVg4Ue6v9BwZOxSYsIerFao7UiUryIqJcqgtpimhbBXoSCVxUFe9CTiogUrUp2Pt+3aUI2u5vdNh4dmMzOzHvvezuz8xNFM0mjnbXaNu1MvFWRXkXEyE6aYOYJpdW4IXuA4r0fo8qqSMDBU0v1HJUgVieAXxzCsdE/YJTdFcVIZQNMyhruOMJKXYFoLfIfIvVIMWdsrd+Rpd86ZmyzzjJmLStqRn0v8lzkb4rVIXvnpScOJuAn2ACC65FkPzEdEy4TPWRLJ2h7z4cArXzzaOdKlbOvKKX25Wl00jSnrwVxAg3o4dRxhO13RBSdNvH0xSARv3adTXbBdTf64IWO2vH0LT+cv4GR1DJt+DUItaQogeBX/chhbTBxEiZ6gftlDNXTrvT7co4ub5A6gp9HIcHvzTa46OS5fBeP87Qm0fQkr4FsYgVQ7Qg+ZayaDg9jhg1GkWj8RG6lkeSacrrHgDaxdoBiZPg+NXV/KifMuB6//JmYH4CntVEHy/keA6x4h4CU5oFy8GzrBS18cLJMXcljAKB6INjWsRcuZBWVaS3GDrqB7rdapVIeA+isQ57Eev9eCqzqOa81CY05VLd6SamW2wA2H3SiTbnbSxmzfp7WtKZkqy4mdyAlGx7ennghYf8voqp9cLSgKdqNfa6RdRsAAkPwRuJZNbpByn+RrJi1RXTwdi8RQF6ymDwGMAtZ6TVE+4uoKh+MYkcLsT0Hk8eAienbiGdjJHZTpmNjlbFJNKDVAp2fJlYju6IreQxQ08UJDNYdoLSl6AadO+fFuCQqVMB1NJwPm69T04Wv5WhfcWyfXQB+wXRs1pt+nCknRa0LVzSA/2B+a9+zQJadb7IyyV24YAxKp2Jqs3emZTuNnKxsah+uabKbMk7CbTgJx/zIgQYErIeTKRQ9yD9wxVof5YolPHqaWo7TD6tJlh7jQnK5z2n3+fGdggIOx2kaa2YI9QWarc5Ce1ipNWMKeSG4DysFF52KBmTNMmn5HqCFkwy34rDg05gDwgH3bBi+sgFhN/e8QvRn8kbamCOhgrZ9GJhFDgfcMHzFb6BAtjKpFhzTjwv1KCVuxHvCbsSiEz4CANnj84cwHdFXAbAOJ4LTSAawGWFn5tDhLMYz6nWeU2wJfIhmIJBefcd/A5FWQWGgrWzyORZ3Q6HuV+Jf0Bj+BTX69fm1zWgK7By1YTXchFDORywnfQ7GpzOo6S+qECrsx2ifVQAAAABJRU5ErkJggg==');
  }

  div.callout-tip.callout-style-default .callout-title {
    background-color: #ccf1e3
  }

  div.callout-caution {
    border-left-color: #fd7e14 !important;
  }

  div.callout-caution .callout-icon::before {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABAAAAGgAAAAAAA6ABAAMAAAABAAEAAKACAAQAAAABAAAAIKADAAQAAAABAAAAIAAAAACshmLzAAACV0lEQVRYCdVWzWoUQRCuqp2ICBLJXgITZL1EfQDBW/bkzUMUD7klD+ATSHBEfAIfQO+iXsWDxJsHL96EHAwhgzlkg8nBg25XWb0zIb0zs9muYYWkoKeru+vn664fBqElyZNuyh167NXJ8Ut8McjbmEraKHkd7uAnAFku+VWdb3reSmRV8PKSLfZ0Gjn3a6Xlcq9YGb6tADjn+lUfTXtVmaZ1KwBIvFI11rRXlWlatwIAAv2asaa9mlB9wwygiDX26qaw1yYPzFXg2N1GgG0FMF8Oj+VIx7E/03lHx8UhvYyNZLN7BwSPgekXXLribw7w5/c8EF+DBK5idvDVYtEEwMeYefjjLAdEyQ3M9nfOkgnPTEkYU+sxMq0BxNR6jExrAI31H1rzvLEfRIdgcv1XEdj6QTQAS2wtstEALLG1yEZ3QhH6oDX7ExBSFEkFINXH98NTrme5IOaaA7kIfiu2L8A3qhH9zRbukdCqdsA98TdElyeMe5BI8Rs2xHRIsoTSSVFfCFCWGPn9XHb4cdobRIWABNf0add9jakDjQJpJ1bTXOJXnnRXHRf+dNL1ZV1MBRCXhMbaHqGI1JkKIL7+i8uffuP6wVQAzO7+qVEbF6NbS0LJureYcWXUUhH66nLR5rYmva+2tjRFtojkM2aD76HEGAD3tPtKM309FJg5j/K682ywcWJ3PASCcycH/22u+Bh7Aa0ehM2Fu4z0SAE81HF9RkB21c5bEn4Dzw+/qNOyXr3DCTQDMBOdhi4nAgiFDGCinIa2owCEChUwD8qzd03PG+qdW/4fDzjUMcE1ZpIAAAAASUVORK5CYII=');
  }

  div.callout-caution.callout-style-default .callout-title {
    background-color: #ffe5d0
  }

  </style>
  <style type="text/css">
    .reveal div.sourceCode {
      margin: 0;
      overflow: auto;
    }
    .reveal div.hanging-indent {
      margin-left: 1em;
      text-indent: -1em;
    }
    .reveal .slide:not(.center) {
      height: 100%;
    }
    .reveal .slide.scrollable {
      overflow-y: auto;
    }
    .reveal .footnotes {
      height: 100%;
      overflow-y: auto;
    }
    .reveal .slide .absolute {
      position: absolute;
      display: block;
    }
    .reveal .footnotes ol {
      counter-reset: ol;
      list-style-type: none; 
      margin-left: 0;
    }
    .reveal .footnotes ol li:before {
      counter-increment: ol;
      content: counter(ol) ". "; 
    }
    .reveal .footnotes ol li > p:first-child {
      display: inline-block;
    }
    .reveal .slide ul,
    .reveal .slide ol {
      margin-bottom: 0.5em;
    }
    .reveal .slide ul li,
    .reveal .slide ol li {
      margin-top: 0.4em;
      margin-bottom: 0.2em;
    }
    .reveal .slide ul[role="tablist"] li {
      margin-bottom: 0;
    }
    .reveal .slide ul li > *:first-child,
    .reveal .slide ol li > *:first-child {
      margin-block-start: 0;
    }
    .reveal .slide ul li > *:last-child,
    .reveal .slide ol li > *:last-child {
      margin-block-end: 0;
    }
    .reveal .slide .columns:nth-child(3) {
      margin-block-start: 0.8em;
    }
    .reveal blockquote {
      box-shadow: none;
    }
    .reveal .tippy-content>* {
      margin-top: 0.2em;
      margin-bottom: 0.7em;
    }
    .reveal .tippy-content>*:last-child {
      margin-bottom: 0.2em;
    }
    .reveal .slide > img.stretch.quarto-figure-center,
    .reveal .slide > img.r-stretch.quarto-figure-center {
      display: block;
      margin-left: auto;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-left,
    .reveal .slide > img.r-stretch.quarto-figure-left  {
      display: block;
      margin-left: 0;
      margin-right: auto; 
    }
    .reveal .slide > img.stretch.quarto-figure-right,
    .reveal .slide > img.r-stretch.quarto-figure-right  {
      display: block;
      margin-left: auto;
      margin-right: 0; 
    }
  </style>
</head>
<body class="quarto-light">
  <div class="reveal">
    <div class="slides">

<section id="title-slide" class="quarto-title-block center">
  <h1 class="title">Initiation à Spark avec R en mode cluster</h1>

<div class="quarto-title-authors">
</div>

</section>
<section id="au-programme" class="slide level2 smaller">
<h2>Au programme</h2>
<ol type="1">
<li class="fragment"><p>MiDAS : une base de données volumineuse 💾</p></li>
<li class="fragment"><p>Manipuler un appariement : une opération coûteuse 💲</p></li>
<li class="fragment"><p>Initiation au calcul distribué : quelles ressources réserver ? 🖥️🖥️🖥️</p></li>
<li class="fragment"><p>Sparklyr : la solution ergonomique de spark sous R 👨‍💻</p></li>
<li class="fragment"><p>Pour aller plus loin ⏩</p></li>
</ol>
</section>
<section id="midas-une-base-de-données-volumineuse" class="slide level2 smaller">
<h2>MiDAS : une base de données volumineuse</h2>
<p>MiDAS croise trois bases de données administratives exhaustives :</p>
<ul>
<li class="fragment"><p>les données sur <strong>l’inscription et l’indemnisation des demandeurs d’emploi</strong> de France Travail : le Fichier Historique Statistique (FHS) et le Fichier National des Allocataires (FNA) ;</p></li>
<li class="fragment"><p>les données sur les bénéficiaires de <strong>minima sociaux</strong> (RSA, PPA, AAH) et les caractéristiques des <strong>ménages</strong> de la CNAF : Allstat-FR6 ;</p></li>
<li class="fragment"><p>les données sur les <strong>contrats salariés</strong> de la DSN : MMO de la Dares.</p></li>
</ul>
</section>
<section id="midas-une-base-de-données-volumineuse-1" class="slide level2 smaller">
<h2>MiDAS : une base de données volumineuse</h2>
<p>Chaque vague de MiDAS correspond à environ <strong>600 Go</strong> de données au format sas. Les vagues fonctionnent par empilement :</p>
<ul>
<li class="fragment"><p>le gain de <strong>profondeur temporelle</strong> et l’entrée dans le champ de nouvelles personnes</p></li>
<li class="fragment"><p>les <strong>vagues sont appariables entre elles</strong></p></li>
</ul>
</section>
<section id="midas-une-base-de-données-volumineuse-2" class="slide level2 smaller">
<h2>MiDAS : une base de données volumineuse</h2>
<p>MiDAS est l’une des bases de données les plus volumineuses du SSP :<img data-src="donnees_ssp.PNG" alt="Quelques bases du SSP"></p>
<p>Les administrations dont les données sont comparables à MiDAS utilisent un cluster Spark : Insee, Drees, Acoss…</p>
<p>▶️Le cluster spark est la solution la plus efficiente pour traiter des données de cette ampleur. Apprendre à l’utiliser pourra vous être utile dans d’autres contextes que celui de la Dares.</p>
</section>
<section id="structure-de-lappariement" class="slide level2 smaller">
<h2>Structure de l’appariement</h2>

<img data-src="structure_midas.PNG" class="quarto-figure quarto-figure-center r-stretch"><div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Pourquoi Spark ?</strong></p>
</div>
<div class="callout-content">
<p>La manipulation des données MiDAS en l’état implique de nombreuses opérations de jointures qui nécessitent une puissance de calcul et un temps certains.</p>
</div>
</div>
</div>
</section>
<section id="le-format-parquet" class="slide level2 smaller scrollable">
<h2>Le format parquet</h2>
<p>Les données sont converties au <strong>format parquet</strong> dès leur réception et mises à disposition sur la bulle CASD du projet MiDares sous l’espace commun. Le format parquet est un format de données adapté aux données volumineuses :</p>
<ul>
<li class="fragment"><p>il <strong>compresse</strong> efficacement les données : taux de compression de 5 à 10 par rapport au format csv</p></li>
<li class="fragment"><p>il est orienté <strong>colonnes</strong></p></li>
<li class="fragment"><p>il permet le chargement efficace <strong>en mémoire</strong> des données</p></li>
<li class="fragment"><p>Il permet le <strong>stockage partitionné</strong> des données</p></li>
<li class="fragment"><p>il permet un traitement de cette partition qui conserve les données non nécessaires <strong>sur disque</strong></p></li>
<li class="fragment"><p>Il est <strong>indépendant du logiciel</strong> utilisé : il peut donc être traité par spark et par R.</p></li>
</ul>
</section>
<section>
<section id="manipuler-un-appariement-une-opération-coûteuse" class="title-slide slide level1 center">
<h1>Manipuler un appariement : une opération coûteuse</h1>

</section>
<section id="lespace-midares" class="slide level2 smaller scrollable">
<h2>L’espace MiDares</h2>
<div class="panel-tabset">
<ul id="tabset-1" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-1-1">Ressources</a></li><li><a href="#tabset-1-2">Schéma</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1">
<p>Des ressources partagées entre tous les utilsateurs simultanés :</p>
<ul>
<li class="fragment">512 Go de mémoire vive (ou RAM) : passage à 256 Go</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>La mémoire vive</strong></p>
</div>
<div class="callout-content">
<p>La mémoire vive, aussi appelée RAM, se distingue de la mémoire de stockage (disque) par sa <strong>rapidité</strong>, notamment pour fournir des données au processeur pour effectuer des calculs, par sa <strong>volatilité</strong> (toutes les données sont perdues si l’ordinateur n’est plus alimenté) et par l’accès direct aux informations qui y sont stockées, <strong>quasi instantanné</strong>.</p>
</div>
</div>
</div>
<ul>
<li class="fragment">Un processeur (ou CPU) composé de 32 coeurs : passage à 16 coeurs</li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Le processeur</strong></p>
</div>
<div class="callout-content">
<p>Le processeur permet d’<strong>exécuter des tâches et des programmes</strong> : convertir un fichier, exécuter un logiciel… Il est composé d’un ou de plusieurs <strong>coeurs</strong> : un coeur ne peut exécuter qu’une seule tâche à la fois. Si le processeur contient plusieurs coeurs, il peut exécuter autant de tâches en parallèle qu’il a de coeurs. Un processeur se caractérise aussi par sa <strong>fréquence</strong> : elle est globalement proportionnelle au nombre d’opérations qu’il est capable d’effetuer par seconde.</p>
</div>
</div>
</div>
</div>
<div id="tabset-1-2">
<p><img data-src="schema_ordinateur.png"></p>
</div>
</div>
</div>
</section>
<section id="programmer-en-mémoire-vive" class="slide level2 smaller">
<h2>Programmer en mémoire vive</h2>
<ul>
<li class="fragment"><p><strong>R : la mémoire vive, état dans l’environnement</strong></p></li>
<li class="fragment"><p>SAS : lecture/écriture sur le disque</p></li>
<li class="fragment"><p>MiDAS au format sas &gt;&gt; taille de la mémoire vive disponible du serveur CASD –&gt; format <code>.parquet</code></p></li>
<li class="fragment"><p><strong>Impossible de charger tout MiDAS en mémoire vive</strong></p>
<p>Des solutions existent pour manipuler les données sous R sans les charger entièrement en mémoire vive :</p></li>
<li class="fragment"><p><code>arrow</code> (avec des requêtes <code>dplyr</code>)</p></li>
<li class="fragment"><p><code>duckDB</code> : recommandé par le SSPLab pour des données jusqu’à 100Go</p>
<p>▶️ Insuffisantes pour les traitements les plus coûteux sur MiDAS en R : la partie de la mémoire vive utilisée pour stocker les données correspond à autant de puissance de calcul indisponible pour les traitements.</p></li>
</ul>
</section>
<section id="les-traitements-coûteux-en-puissance-de-calcul" class="slide level2 smaller">
<h2>Les traitements coûteux en puissance de calcul</h2>
<ul>
<li class="fragment"><p>les jointures</p></li>
<li class="fragment"><p>les opérations en <code>group_by()</code></p></li>
<li class="fragment"><p><code>distinct()</code></p>
<p>▶️ Exécution séquentielle sur un coeur du processeur + beaucoup de mémoire vive (données temporaires)</p>
<p>▶️ Erreur “out of memory”.</p></li>
</ul>
</section>
<section id="un-traitement-peu-coûteux-un-traitement-map" class="slide level2 smaller">
<h2>Un traitement peu coûteux : un traitement MAP</h2>

<img data-src="formation sparklyr-Page-1.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="800"><p>Ce traitement est peu coûteux :</p>
<ul>
<li class="fragment"><p>chargement d’une seule colonne en RAM : format parquet orienté colonnes</p></li>
<li class="fragment"><p>peu de mémoire d’exécution : R est un langage vectorisé</p></li>
</ul>
</section>
<section id="un-traitement-coûteux-un-traitement-reduce" class="slide level2 smaller">
<h2>Un traitement coûteux : un traitement REDUCE</h2>

<img data-src="formation sparklyr-Page-2.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="850"><p>Ce traitement nécessite :</p>
<ul>
<li class="fragment"><p>le chargement de davantage de colonnes en mémoire vive ;</p></li>
<li class="fragment"><p>davantage de mémoire d’exécution pour effectuer l’intersection (<code>inner_join()</code>).</p></li>
</ul>
</section></section>
<section>
<section id="initiation-au-calcul-distribué" class="title-slide slide level1 center">
<h1>Initiation au calcul distribué</h1>

</section>
<section id="calcul-distribué-et-calcul-parallèle" class="slide level2 smaller">
<h2>Calcul distribué et calcul parallèle</h2>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="calcul-non-distribué">Calcul non distribué</h3>
<p>Les problématiques Big Data en R sont les suivantes :</p>
<ul>
<li class="fragment"><p>la taille des données : chargées en mémoire pour effectuer les calculs avec R</p></li>
<li class="fragment"><p>le temps de calcul : les étapes du traitement sont effectuées de manière séquentielle par le processeur (très long)</p></li>
<li class="fragment"><p>l’optimisation du programme</p></li>
</ul>
</div><div class="column" style="width:50%;">
<h3 id="calcul-distribué-spark">Calcul distribué spark</h3>
<p>Le calcul distribué avec spark apporte une solution à ces problématiques :</p>
<ul>
<li class="fragment"><p>chargement des données en mémoire parcimonieux et non systématique</p></li>
<li class="fragment"><p>exécution de tâches en parallèle sur plusieurs coeurs du processeur, voire sur plusieurs ordinateurs différents</p></li>
<li class="fragment"><p>optimisation automatique du code</p></li>
</ul>
</div></div>
</section>
<section id="un-traitement-map-distribué" class="slide level2 smaller">
<h2>Un traitement MAP distribué</h2>

<img data-src="map_distribue.drawio.png" class="r-stretch"><p>Si les données sont stockées sur différents ordinateurs :</p>
<ul>
<li class="fragment"><p>les calculs peuvent être effectués en parallèle ;</p></li>
<li class="fragment"><p>gain de temps lié à l’augmentation des ressources informatiques pour effectuer le calcul et à la parallélisation.</p></li>
</ul>
<p>Les traitements MAP se prêtent parfaitement au calcul distribué et parallèle.</p>
</section>
<section id="un-traitement-reduce-distribué" class="slide level2 smaller">
<h2>Un traitement REDUCE distribué</h2>

<img data-src="reduce_distribue.drawio.png" class="r-stretch"><p>Si les données sont stockées sur différents ordinateurs :</p>
<ul>
<li class="fragment"><p>il faut les rappatrier au même endroit pour effectuer la jointure ;</p></li>
<li class="fragment"><p>cet échange est effectué en réseau entre les ordinateurs : l’envoi réseau a un coût non négligeable en temps.</p></li>
</ul>
<p>Les traitements REDUCE ne se prêtent pas bien au calcul distribué et parallèle.</p>
</section>
<section id="spark" class="slide level2 smaller scrollable">
<h2>Spark</h2>
<ul>
<li class="fragment"><p>Apache Spark : <strong>librairie open source</strong> développée dans le langage <code>scala</code></p></li>
<li class="fragment"><p><strong>Scala</strong> : langage compilé, rapide et distribuable qui peut être exécuté dans une machine virtuelle Java</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a></a>val TopHorrorsIGN2022 <span class="ot">=</span> <span class="fu">Seq</span>(</span>
<span id="cb1-2"><a></a>  (<span class="dv">9</span>, <span class="st">"Pearl"</span>),</span>
<span id="cb1-3"><a></a>  (<span class="dv">6</span>, <span class="st">"The Sadness"</span>),</span>
<span id="cb1-4"><a></a>  (<span class="dv">6</span>, <span class="st">"Offseason"</span>),</span>
<span id="cb1-5"><a></a>  (<span class="dv">7</span>, <span class="st">"Hatching"</span>),</span>
<span id="cb1-6"><a></a>  (<span class="dv">8</span>, <span class="st">"x"</span>)</span>
<span id="cb1-7"><a></a>)<span class="fu">.toDF</span>(<span class="st">"IMDB Rating"</span>, <span class="st">"IGN Movie Picks"</span>)</span>
<span id="cb1-8"><a></a></span>
<span id="cb1-9"><a></a>val TopHorrorsTheAVClub2022 <span class="ot">=</span> <span class="fu">Seq</span>(</span>
<span id="cb1-10"><a></a>  (<span class="dv">7</span>, <span class="st">"Nope"</span>),</span>
<span id="cb1-11"><a></a>  (<span class="dv">9</span>, <span class="st">"Pearl"</span>),</span>
<span id="cb1-12"><a></a>  (<span class="dv">8</span>, <span class="st">"x"</span>),</span>
<span id="cb1-13"><a></a>  (<span class="dv">5</span>, <span class="st">"Barbarian"</span>),</span>
<span id="cb1-14"><a></a>  (<span class="dv">5</span>, <span class="st">"Bones And All"</span>)</span>
<span id="cb1-15"><a></a>)<span class="fu">.toDF</span>(<span class="st">"IMDB Rating"</span>, <span class="st">"AVC Movie Picks"</span>)</span>
<span id="cb1-16"><a></a></span>
<span id="cb1-17"><a></a>import org.apache.spark.sql.functions.col</span>
<span id="cb1-18"><a></a></span>
<span id="cb1-19"><a></a>val cols <span class="ot">=</span> <span class="fu">List</span>(<span class="fu">col</span>(<span class="st">"IGN Movie Picks"</span>), <span class="fu">col</span>(<span class="st">"AVC Movie Picks"</span>))</span>
<span id="cb1-20"><a></a></span>
<span id="cb1-21"><a></a>val query <span class="ot">=</span> <span class="fu">TopHorrorsIGN2022</span>(</span>
<span id="cb1-22"><a></a>  <span class="st">"IGN Movie Picks"</span></span>
<span id="cb1-23"><a></a>) <span class="sc">==</span><span class="er">=</span> <span class="fu">TopHorrorsTheAVClub2022</span>(<span class="st">"AVC Movie Picks"</span>)</span>
<span id="cb1-24"><a></a></span>
<span id="cb1-25"><a></a>val outerJoin <span class="ot">=</span> TopHorrorsIGN2022</span>
<span id="cb1-26"><a></a>  <span class="fu">.join</span>(TopHorrorsTheAVClub2022, query, <span class="st">"outer"</span>)</span>
<span id="cb1-27"><a></a>  <span class="fu">.select</span>(cols<span class="sc">:</span> _<span class="sc">*</span>)</span>
<span id="cb1-28"><a></a></span>
<span id="cb1-29"><a></a><span class="fu">outerJoin.show</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p><code>scala</code> adapté pour maîtriser toutes les fonctionnalités de <code>spark</code> et optimiser au maximum les traitements en <code>spark</code></p></li>
<li class="fragment"><p><code>spark</code> est <strong>compatible avec les langages</strong> <code>scala</code>, <code>R</code>, <code>python</code>, <code>java</code>, et peut interpréter des commandes <strong>SQL.</strong></p></li>
<li class="fragment"><p>Deux packages existent sous R :</p>
<ul>
<li class="fragment"><p><strong>sparkR</strong> proposé par Apache Spark</p></li>
<li class="fragment"><p><strong>sparklyr</strong>, qui permet d’utiliser directement des commandes dplyr traduites en spark par le package.</p></li>
</ul></li>
</ul>
</section>
<section id="installation-de-spark-sous-casd" class="slide level2 smaller">
<h2>Installation de spark sous CASD</h2>
<p>Voir la fiche dédiée sur le site</p>
</section>
<section id="la-machine-virtuelle-java" class="slide level2 smaller">
<h2>La machine virtuelle Java</h2>
<p>Spark est rédigé en scala, un langage qui a besoin d’une machine virtuelle Java pour être exécuté. La machine virtuelle Java est scalable : l’utilisateur peut choisir quelles ressources physiques elle a le droit d’utiliser sur l’ensemble des ressources physiques disponibles sur l’ordinateur. C’est un mini ordinateur créé par spark à l’intérieur de notre propre ordinateur, qui utilise les ressources de ce dernier.</p>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Machine virtuelle</strong></p>
</div>
<div class="callout-content">
<p>Une machine virtuelle a les mêmes caractéristiques qu’un ordinateur :</p>
<ul>
<li class="fragment"><p>un système d’exploitation : Windows, Linux, MacOS</p></li>
<li class="fragment"><p>des ressources physiques : CPU, RAM et stockage disque</p></li>
</ul>
<p>La différence avec un ordinateur : une machine virtuelle peut être créée sur un serveur physique en réservant une petite partie des ressources du serveur seulement, ce qui permet de créer plusieurs ordinateurs différents sur une seule infractructure physique</p>
</div>
</div>
</div>
</section>
<section id="deux-manières-dutiliser-spark" class="slide level2 smaller scrollable">
<h2>Deux manières d’utiliser Spark</h2>
<div class="columns">
<div class="column" style="width:50%;">
<h3 id="avec-un-seul-ordinateur">Avec un seul ordinateur</h3>
<p>Ce mode est appelé Spark local.</p>
<ul>
<li class="fragment"><p>une unique machine virtuelle Java est créée pour exécuter le code spark</p></li>
<li class="fragment"><p>tâches parallélisées sur les différents coeurs (CPU) du processeur de la machine virtuelle Java</p></li>
<li class="fragment"><p>l’ordinateur sur lequel est créée cette machine virtuelle Java est la bulle MiDARES, équivalent d’un unique gros ordinateur</p></li>
</ul>
</div><div class="column" style="width:50%;">
<h3 id="sur-un-cluster-de-calcul">Sur un cluster de calcul</h3>
<p>Un cluster de calcul est un ensemble d’ordinateurs ou machines virtuelles connectés en réseau.</p>
<ul>
<li class="fragment"><p>une machine virtuelle Java est créée par spark dans chaque ordinateur du cluster</p></li>
<li class="fragment"><p>tâches parallélisées sur les différents ordinateurs du cluster</p></li>
<li class="fragment"><p>la session R reste sur la bulle MiDARES, le code R est traduit en scala puis envoyé sur le cluster pour être exécuté.</p></li>
</ul>
</div></div>
</section>
<section id="mode-local-schéma" class="slide level2 smaller">
<h2>Mode local : schéma</h2>

<img data-src="mode_local.PNG" class="r-stretch"></section>
<section id="mode-local-à-éviter" class="slide level2 smaller">
<h2>Mode local : à éviter</h2>
<p>En mode local :</p>
<ul>
<li class="fragment"><p>les ressources utilisées par la machine virtuelle sont celles de la bulle</p></li>
<li class="fragment"><p>il faut allouer suffisamment de coeurs à la JVM pour paralléliser</p></li>
<li class="fragment"><p>même si l’utilisateur choisit des ressources faibles, les ressources réelles utilisées dans une session spark peuvent être plus élevées : mauvaise gestion de l’allocation des ressources</p></li>
<li class="fragment"><p>accélération sensible par rapport à un mode de programmation classique séquentiel sur un unique coeur si beaucoup de ressources</p></li>
<li class="fragment"><p>Sur la bulle CASD, mauvaise gestion de la répartition des ressources en spark local : l’utilisation simultanée de spark par plusieurs membres de la bulle entraînent des ralentissements considérables</p>
<p>▶️mode local à éviter absolument</p></li>
</ul>
</section>
<section id="le-cluster-de-calcul-midares-présentation" class="slide level2 smaller">
<h2>Le cluster de calcul Midares : présentation</h2>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="691"></section>
<section id="se-connecter-à-spark-sur-un-cluster" class="slide level2 smaller">
<h2>Se connecter à Spark sur un cluster</h2>
<p>Se connecter à spark revient à demander à spark de créer toutes les JVM demandées capables de lire du scala.</p>
<p>Pour se connecter à spark depuis R avec le package <code>sparklyr</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2" data-code-line-numbers="4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a></a><span class="fu">library</span>(sparklyr)</span>
<span id="cb2-2"><a></a></span>
<span id="cb2-3"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb2-4"><a></a>conf<span class="sc">$</span>spark.executor.instances <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-5"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Le paramètre <code>spark.executor.instances</code> correspond au nombre d’ordinateurs sur lequel on souhaite paralléliser le travail d’exécution de code. Ici, l’utilisateur demande 5 ordinateurs du cluster.</p>
<p>Nous verrons plus loin quels paramètres nous devons préciser dans le fichier de configuration.</p>
</section>
<section id="une-connexion" class="slide level2 smaller">
<h2>Une connexion</h2>
<p>Toutes les JVM demandées (5) sont instanciées dans les ordinateurs du cluster, avec les paramètres définis.</p>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="691"></section>
<section id="la-vie-dun-programme-rédigé-en-sparklyr" class="slide level2 smaller">
<h2>La vie d’un programme rédigé en sparklyr</h2>
<p>Avec <code>sparklyr</code>, il est possible de programmer directement en <code>dplyr</code> pour utiliser spark.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a></a><span class="co"># un data frame que j'envoie dans spark</span></span>
<span id="cb3-2"><a></a>un_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>))</span>
<span id="cb3-3"><a></a><span class="fu">names</span>(un_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"col_num"</span>, <span class="st">"col_char"</span>)</span>
<span id="cb3-4"><a></a></span>
<span id="cb3-5"><a></a><span class="co"># C'est maintenant un spark_data_frame</span></span>
<span id="cb3-6"><a></a><span class="fu">copy_to</span>(sc, un_df)</span>
<span id="cb3-7"><a></a>    </span>
<span id="cb3-8"><a></a>un_df_transforme <span class="ot">&lt;-</span> un_df <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a></a>    <span class="fu">mutate</span>(<span class="at">une_nouvelle_col =</span> col_num<span class="sc">*</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si j’exécute ce programme, je ne pourrai pas ouvrir <code>un_df_transforme</code>, d’ailleurs, il ne se sera rien passé.</p>
</section>
<section id="la-lazy-evaluation" class="slide level2 smaller scrollable">
<h2>La lazy evaluation</h2>
<p>Spark distingue deux types d’opérations :</p>
<ul>
<li class="fragment"><p><strong>les transformations :</strong> ce sont des opérations qui prennent en entrée un <code>spark_data_frame</code> et retournent un <code>spark_data_frame</code>, elles ne déclenchent aucun calcul lorsqu’elles sont appelées.</p>
<p>Par exemple, le programme ci-dessous est compilé instantanément et ne déclenche pas d’exécution :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a></a>une_transformation <span class="ot">&lt;-</span> un_spark_data_frame <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a></a>  <span class="fu">group_by</span>(identifiant) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a></a>  <span class="fu">mutate</span>(<span class="at">une_somme =</span> <span class="fu">sum</span>(revenus))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p><strong>les actions :</strong> ce sont des opérations qui demandent le calcul d’un résultat et qui déclenchent le calcul et l’exécution de toutes les transformations compilées jusqu’à l’appel de l’action.</p>
<p>Par exemple, le programme ci-dessous déclenche le calcul de la cellule <code>une_transformation</code> et de la moyenne des revenus :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a></a>revenu_moyen <span class="ot">&lt;-</span> une_transformation <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a></a>  <span class="fu">summarise</span>(<span class="at">revenu_moyen =</span> <span class="fu">mean</span>(une_somme)) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Les principales actions sont : <code>print()</code>, <code>collect()</code>, <code>head()</code>, <code>tbl_cache()</code> (écrire un <code>spark_data_frame</code> en mémoire pour le réutiliser).</p></li>
</ul>
</section>
<section id="la-vie-dun-programme-rédigé-en-sparklyr-1" class="slide level2">
<h2>La vie d’un programme rédigé en sparklyr</h2>
<p>Prenons l’exemple d’un programme contenant une action.</p>
</section>
<section id="le-rôle-du-driver" class="slide level2 smaller">
<h2>Le rôle du driver</h2>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="400"><ul>
<li class="fragment"><p>Le programme R est traduit en scala grâce au package <code>sparklyr</code></p></li>
<li class="fragment"><p>Le driver évalue le programme, il lit le code <code>scala</code> mais n’exécute rien du tout</p></li>
<li class="fragment"><p>S’il remarque une erreur, l’erreur est envoyée directement à l’utilisateur en session R avant l’exécution du programme : c’est la force de la lazy evaluation.</p></li>
</ul>
</section>
<section id="le-plan-dexécution" class="slide level2 smaller">
<h2>Le plan d’exécution</h2>

<img data-src="catalyst.jpg" class="r-stretch"><p>source : documentation CASD disponible à <a href="https://casd-eu.gitbook.io/data-science/">Documentation Data Science</a></p>
<p>AJOUTER UN DAG</p>
</section>
<section id="le-rôle-du-driver-catalyst" class="slide level2 smaller scrollable">
<h2>Le rôle du driver : Catalyst</h2>
<p>Le driver contient un programme nommé Catalyst qui optimise le code <code>scala</code> automatiquement.</p>
<p>Spark optimise automatiquement les programmes soumis :</p>
<ol type="1">
<li class="fragment"><p>Compilation des transformations pour soulever les éventuelles erreurs</p></li>
<li class="fragment"><p>Intégration dans un <strong>plan d’exécution</strong> contenant les étapes nécessaires pour parvenir au résultat demandé par le programme</p></li>
<li class="fragment"><p>Optimisation du plan logique par le module <strong>Catalyst</strong> (driver Spark)</p></li>
</ol>
<p>Par exemple si j’écris le programme :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a></a>non_optimal <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span>   </span>
<span id="cb6-2"><a></a>    <span class="fu">mutate</span>(<span class="at">duree_contrat =</span> <span class="fu">DATEDIFF</span>(fin_contrat, debut_contrat)) <span class="sc">%&gt;%</span>   </span>
<span id="cb6-3"><a></a>    <span class="fu">filter</span>(debut_contrat <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Catalyst réécrit :</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a></a>optimal <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span>   </span>
<span id="cb8-2"><a></a>    <span class="fu">filter</span>(debut_contrat <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb8-3"><a></a>    <span class="fu">mutate</span>(<span class="at">duree_contrat =</span> <span class="fu">DATEDIFF</span>(fin_contrat, debut_contrat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cette optimisation est réalisée sur toutes les transformations compilée avant qu’une action déclenche l’exécution.</p>
</section>
<section id="le-rôle-du-driver-catalyst-1" class="slide level2 smaller scrollable">
<h2>Le rôle du driver : Catalyst</h2>

<img data-src="dag.webp" class="r-stretch"></section>
<section id="le-rôle-du-driver-catalyst-2" class="slide level2 smaller scrollable">
<h2>Le rôle du driver : Catalyst</h2>
<ol start="4" type="1">
<li class="fragment"><p>Réalisation de plans physiques possibles et sélection du <strong>meilleur plan physique</strong> (au regard de la localisation des données requises). Le plan physique est la distribution des différents calculs aux machines du cluster.</p></li>
<li class="fragment"><p><strong>Déclencher le moins d’actions possibles</strong> dans son programme permet de tirer pleinement parti de Catalyst et de gagner un temps certain.</p></li>
<li class="fragment"><p>Pour profiter des avantages de spark, la manière de programmer recommandée est différente de celle prédominante en R classique.</p></li>
</ol>
</section>
<section id="le-rôle-du-cluster-manager" class="slide level2 smaller">
<h2>Le rôle du cluster manager</h2>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="400"><p>Le cluster manager distribue les traitements physiques aux ordinateurs du cluster :</p>
<ul>
<li class="fragment"><p>il connaît le meilleur plan physique fourni par Catalyst ;</p></li>
<li class="fragment"><p>il connaît les ressources disponibles et occupées par toutes les machines du cluster ;</p></li>
<li class="fragment"><p>il affecte les ressources disponibles à la session spark.</p></li>
</ul>
</section>
<section id="le-rôle-du-worker" class="slide level2 smaller">
<h2>Le rôle du worker</h2>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="400"><p>Le worker effectue le morceau de programme qu’on lui affecte et renvoie le résultat au driver, qui lui-même affiche le résultat en session R :</p>
<ul>
<li class="fragment"><p>il ne connaît que les tâches qu’on lui a affectées ;</p></li>
<li class="fragment"><p>il peut communiquer avec le driver en réseau pour renvoyer un résultat ;</p></li>
<li class="fragment"><p>il peut communiquer avec les autres workers en réseau pour partager des données ou des résultats intermédiaires : c’est un shuffle.</p></li>
</ul>
</section>
<section id="où-sont-les-données" class="slide level2 smaller">
<h2>Où sont les données ?</h2>

<img data-src="schema_cluster.drawio.png" class="quarto-figure quarto-figure-center r-stretch" width="400"></section>
<section id="où-sont-les-données-1" class="slide level2">
<h2>Où sont les données ?</h2>

<img data-src="hdfs_browse.png" class="r-stretch"></section>
<section id="transfert-de-la-bulle-à-hdfs" class="slide level2 smaller">
<h2>Transfert de la bulle à HDFS</h2>

<img data-src="hdfs_dowload.PNG" class="r-stretch"></section>
<section id="transfert-de-hdfs-à-la-bulle" class="slide level2 smaller">
<h2>Transfert de HDFS à la bulle</h2>

<img data-src="hdfs_midas.PNG" class="r-stretch"></section>
<section id="mais-où-sont-réellement-les-données-hdfs" class="slide level2 smaller">
<h2>Mais où sont réellement les données ? HDFS</h2>
<p>Hadoop Distributed File System (HDFS)</p>
<ul>
<li class="fragment"><p><strong>stockage sur différentes machines :</strong> ici les noeuds du cluster spark, c’est-à-dire les différents ordinateurs workers du cluster</p></li>
<li class="fragment"><p>données divisées <strong>en blocs</strong> plus petits de taille fixe et répartis sur les machines : aucune table de MiDAS n’existe en entier sur le cluster</p></li>
<li class="fragment"><p>chaque bloc est <strong>répliqué trois fois</strong> : il existe trois fois les 10 premières lignes de la table FNA sur trois ordinateurs différents du cluster (résilience)</p></li>
<li class="fragment"><p>un <strong>NameNode</strong> supervise les <strong>métadonnées</strong> et gère la structure du système de fichiers</p></li>
<li class="fragment"><p>les <strong>DataNodes</strong> stockent effectivement les blocs de données : les datanodes sont en fait les disques des workers du cluster, chaque ordinateur du cluster dispose d’un disque avec une partie des données MiDAS</p></li>
<li class="fragment"><p>le <strong>système HDFS</strong> est relié à la bulle Midares : possible de charger des données en clique-bouton de la bulle vers HDFS de manière très rapide et de télécharger des tables de HDFS pour les récupérer en local</p></li>
</ul>
</section></section>
<section>
<section id="programmer-avec-sparklyr" class="title-slide slide level1 center">
<h1>Programmer avec sparklyr</h1>

</section>
<section id="paramétrer-sa-session" class="slide level2 smaller scrollable">
<h2>Paramétrer sa session</h2>
<p>Il faut préciser quelles ressources réserver pour chaque unité spark : le driver, le nombre d’ordinateurs workers (appelées instances), la RAM, le nombre de coeurs</p>
<p>La configuration par défaut est :</p>
<p>Il est nécessaire de configurer la session spark pour établir une connexion entre la session R et un cluster spark. Les paramètres à définir sont :</p>
<ul>
<li class="fragment"><p>Les ressources physiques utilisées :</p>
<ol type="1">
<li class="fragment"><p>par le <strong>driver</strong> : avec <code>spark.driver.memory</code> <strong>(avec parcimonie)</strong></p></li>
<li class="fragment"><p>par chaque <strong>worker</strong> avec <code>spark.executor.memory</code>(valeur max <strong>140 Go</strong>) et <code>spark.executor.cores</code> (valeur max <strong>8 coeurs</strong>)</p></li>
<li class="fragment"><p>le nombre de <strong>workers</strong> avec <code>spark.executor.instances</code> <strong>(2 ou 3 suffisent)</strong></p></li>
<li class="fragment"><p>La <strong>file</strong> sur laquelle on travaille avec <code>spark.yarn.queue</code> <strong>(prod ou dev)</strong></p></li>
</ol></li>
<li class="fragment"><p>le nombre de <strong>partitions</strong> de chaque <code>spark_data_frame</code> avec <code>spark.sql.shuffle.partitions</code> <strong>(200 par défaut)</strong></p></li>
<li class="fragment"><p>la <strong>limite de taille des résulats</strong> qui peuvent être <strong>collectés</strong> par le driver avec <code>spark.driver.maxResultSize</code> <strong>(0 est la meilleure option)</strong></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb9-2"><a></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb9-3"><a></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"60Go"</span></span>
<span id="cb9-4"><a></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb9-5"><a></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb9-6"><a></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb9-7"><a></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-8"><a></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb9-9"><a></a></span>
<span id="cb9-10"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mode-cluster-non-concurrence-grâce-au-cluster-manager" class="slide level2 smaller">
<h2>Mode cluster : non concurrence grâce au cluster manager</h2>

<img data-src="mode_cluster.PNG" class="r-stretch"><p>Le mode cluster permet une réelle distribution sur différents noeuds, qui sont en fait des ordinateurs distincts d’un serveur. Ces machines communiquent en réseau.</p>
<p>Capture d’écran réservation des ressources</p>
<p>Il est donc nécessaire de se déconnecter pour libérer les ressources : des ressources réservées, même lorsqu’aucun programme ne tourne, ne peuvent jamais être affectées à d’autres utilisateurs.</p>
</section>
<section id="importer-les-données-depuis-hdfs-sous-r" class="slide level2 smaller scrollable">
<h2>Importer les données depuis HDFS sous R</h2>
<p>Les données doivent être disponibles dans les workers sous forme de <code>spark_data_frame</code> :</p>
<ul>
<li class="fragment"><p><strong>caché en mémoire directement</strong> : si utilisées de très nombreuses fois pour gagner du temps</p></li>
<li class="fragment"><p>laissé sur disque tant qu’aucune action ne déclenche un traitement qui nécessite son chargement en mémoire</p>
<p>▶️ chargement en mémoire vive couteux en temps : avec la configuration présentée, le chargement du FNA, du FHS et des MMO prend au moins 25 minutes.</p></li>
<li class="fragment"><p>Pour passer un <code>data.frame</code> R en spark_data_frame : <code>copy_to()</code></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a></a>pjc_df_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb10-2"><a></a>                                  <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/FNA/pjc.parquet"</span>,</span>
<span id="cb10-3"><a></a>                                  <span class="at">memory =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a></a></span>
<span id="cb10-5"><a></a>pjc_filtree <span class="ot">&lt;-</span> pjc_df_spark <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a></a>  <span class="fu">filter</span>(KDDPJ <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>))</span>
<span id="cb10-7"><a></a></span>
<span id="cb10-8"><a></a><span class="fu">spark_write_parquet</span>(pjc_filtree, <span class="st">"hdfs:///tmp/pjc_filtree.parquet"</span>)</span>
<span id="cb10-9"><a></a></span>
<span id="cb10-10"><a></a>pjc_df_spark <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(sc, <span class="st">"PJC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="les-exports-sur-hdfs" class="slide level2 smaller scrollable">
<h2>Les exports sur HDFS</h2>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Les exports sur HDFS</strong></p>
</div>
<div class="callout-content">
<p>Lorsqu’on exporte une table depuis notre session R vers HDFS, celle-ci est <strong>automatiquement partitionnée</strong>, comme le reste des données.</p>
<p>Ainsi, cette table sera stockée en plusieurs morceaux sous HDFS et répliquée.</p>
<p>Il est possible de maîtriser le nombre de partitions avec la commande <code>sdf_coalesce(partitions = 5)</code> du package <code>sparklyr</code>.</p>
<p>L’idéal est d’<strong>adapter le nombre de partitions à la taille d’un bloc</strong> : un bloc mesure 128 MB. Lorsqu’un bloc disque est utilisé, même à 1%, il n’est pas utilisable pour un autre stockage.</p>
<p>Exporter un fichier de 1MB en 200 partitions réserve 200 blocs inutilement.</p>
</div>
</div>
</div>
</section>
<section id="les-shuffles" class="slide level2 smaller">
<h2>Les shuffles</h2>

<img data-src="reduce_distribue.drawio.png" class="r-stretch"><p>Comme nous l’avons vu, les traitements REDUCE ne se prêtent pas très bien au calcul distribué :</p>
<ul>
<li class="fragment"><p>augmenter le nombre de workers augmente la probabilité de devoir effectuer des shuffles</p></li>
<li class="fragment"><p>il est recommandé de se limiter à deux workers comme dans la configuration proposée</p></li>
<li class="fragment"><p>réserver d’autres ressources n’est souvent pas efficient et monopolise les ressources pour les autres utilisateurs.</p></li>
</ul>
</section>
<section id="récupérer-un-résultat" class="slide level2 smaller">
<h2>Récupérer un résultat</h2>
<p>Les résultats qu’il est recommandé de récupérer en mémoire vive en session R sont de la forme suivante :</p>
<ul>
<li class="fragment"><p><strong>une table filtrée</strong> avec les variables nécessaires à l’étude uniquement : sous MiDAS, toutes les jointures, les calculs de variable et les filtres peuvent être effectués de manière efficiente sous la forme de spark_data_frame, sans jamais collecter les données MiDAS ;</p></li>
<li class="fragment"><p>des <strong>statistiques descriptives synthétiques ;</strong></p></li>
<li class="fragment"><p>les <strong>premières lignes</strong> de la table pour vérifier que le programme retourne bien le résultat attendu ;</p></li>
<li class="fragment"><p>une <strong>table agrégée</strong> pour un graphique par exemple, à l’aide de la fonction <code>summarise()</code>.</p></li>
</ul>
</section>
<section id="lutilisation-de-la-mémoire-du-driver" class="slide level2 smaller">
<h2>L’utilisation de la mémoire du driver</h2>

<img data-src="collect.drawio.png" class="r-stretch"></section>
<section id="lutilisation-de-la-mémoire-du-driver-1" class="slide level2 smaller scrollable">
<h2>L’utilisation de la mémoire du driver</h2>
<p>Lorsqu’il est nécessaire de collecter une table volumineuse, il faut donc prévoir assez de mémoire RAM pour le driver.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11" data-code-line-numbers="2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb11-2"><a></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb11-3"><a></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb11-4"><a></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb11-5"><a></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb11-6"><a></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb11-7"><a></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-8"><a></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb11-9"><a></a></span>
<span id="cb11-10"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-caution callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Bonne pratique de partage des ressources</strong></p>
</div>
<div class="callout-content">
<p>Le driver est instancié dans la bulle Midares, qui a vocation à être réduite suite à la généralisation du cluster.</p>
<ul>
<li class="fragment"><p>La bulle Midares a besoin de RAM minimale pour fonctionner, 100% des ressources ne sont donc pas disponibles pour <code>sparklyr</code>.</p></li>
<li class="fragment"><p>Pour permettre le <strong>travail simultané fluide de 10 utilisateurs</strong>, la mémoire allouée au driver recommandée pour chaque utilisateur est de <strong>15 Go</strong>.</p></li>
<li class="fragment"><p><strong>L’export d’une table</strong> <code>sdf</code> directement au format <code>.parquet</code> est une alternative plus rapide, plus efficiente et qui permet par la suite de charger ses données en R classique et de travailler sur un <code>df</code> R sans utiliser <code>sparklyr</code>.</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="comment-tester-son-code-pour-collecter-le-moins-possible" class="slide level2 smaller scrollable">
<h2>Comment tester son code pour collecter le moins possible ?</h2>
<p>La programmation en spark doit être adaptée aux contraintes de volumétrie des données : test de chaque étape, puis ne forcer le calcul qu’à la fin pour que Catalyst optimise l’ensemble du programme</p>
<p>La principale différence avec la programmation en R classique est que <strong>la visualisation de tables complètes volumineuses n’est pas recommandée</strong> :</p>
<ul>
<li class="fragment"><p><strong>goulets d’étranglement</strong> même avec spark, car toutes les données sont rapatriées vers le driver puis vers la session R ;</p></li>
<li class="fragment"><p><strong>longue :</strong> échange entre tous les noeuds impliqués dans le calcul et le driver, puis un échange driver-session R ;</p></li>
<li class="fragment"><p><strong>beaucoup moins efficace que l’export direct en parquet</strong> du résultat (presque instantanné) : charger ensuite sa table finale en data frame R classique pour effectuer l’étude.</p></li>
</ul>
<p>S’il est nécessaire de collecter, il faut prévoir <strong>beaucoup de RAM pour le driver avec le paramètre</strong> <code>spark.driver.memory</code><strong>.</strong></p>
</section></section>
<section>
<section id="sparklyr-la-solution-ergonomique-de-spark-sous-r" class="title-slide slide level1 center">
<h1>Sparklyr : la solution ergonomique de spark sous R</h1>

</section>
<section id="ce-qui-change-pour-lutilisateur" class="slide level2 smaller">
<h2>Ce qui change pour l’utilisateur</h2>
<p>La majorité des commandes <code>dplyr</code> fonctionnent sur un spark_data_frame avec le package <code>sparklyr</code>. Les divergences principales sont les suivantes :</p>
<table class="caption-top">
<colgroup>
<col style="width: 37%">
<col style="width: 23%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th>Fonctionnalité</th>
<th>tidyverse</th>
<th>sparklyr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>import d’un fichier <code>.parquet</code></td>
<td><code>read_parquet</code></td>
<td><code>spark_read_parquet()</code></td>
</tr>
<tr class="even">
<td>tri d’un tableau</td>
<td><code>arrange()</code></td>
<td><code>window_order()</code> ou <code>sdf_sort()</code></td>
</tr>
<tr class="odd">
<td>opérations sur les dates</td>
<td><code>lubridate</code></td>
<td>fonctions Hive</td>
</tr>
<tr class="even">
<td>empiler des tableaux</td>
<td><code>bind_rows()</code></td>
<td><code>sdf_bind_rows()</code></td>
</tr>
<tr class="odd">
<td>nombre de lignes d’un tableau</td>
<td><code>nrow()</code></td>
<td><code>sdf_nrow()</code></td>
</tr>
<tr class="even">
<td>faire pivoter un tableau</td>
<td><code>tidyr</code></td>
<td><code>sdf_pivot()</code></td>
</tr>
<tr class="odd">
<td>export d’un <code>spark_data_frame</code></td>
<td></td>
<td><code>spark_write_parquet()</code></td>
</tr>
</tbody>
</table>
</section>
<section id="quelques-fonctions-spécifiques" class="slide level2 smaller scrollable">
<h2>Quelques fonctions spécifiques</h2>
<div class="panel-tabset">
<ul id="tabset-2" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-2-1">Dates</a></li><li><a href="#tabset-2-2">Tableau</a></li><li><a href="#tabset-2-3">Statistiques</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1">
<p>Les fonctions de <code>lubridate()</code>ne sont pas adaptées au <code>spark_data_frames</code>.</p>
<ul>
<li class="fragment"><p>Convertir une chaîne de caractère de la forme AAAA-MM-DD en Date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a></a>date_1 <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2024-05-26"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Calculer une durée entre deux dates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a></a>PJC_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb13-2"><a></a>                                <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/pjc.parquet"</span>,</span>
<span id="cb13-3"><a></a>                                <span class="at">memory =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-4"><a></a></span>
<span id="cb13-5"><a></a>duree_pjc_df <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a></a>  <span class="fu">rename</span>(<span class="at">date_fin_pjc =</span> <span class="fu">as.Date</span>(KDFPJ),</span>
<span id="cb13-7"><a></a>         <span class="at">date_deb_pjc =</span> <span class="fu">as.Date</span>(KDDPJ)) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a></a>  <span class="fu">mutate</span>(<span class="at">duree_pjc =</span> <span class="fu">datediff</span>(date_fin_pjc, date_deb_pjc) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Ajouter ou soustraire des jours ou des mois à une date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a></a>duree_pjc_bis_df <span class="ot">&lt;-</span> duree_pjc_df <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a></a>  <span class="fu">mutate</span>(<span class="at">duree_pjc_plus_5 =</span> <span class="fu">date_add</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">5</span>)),</span>
<span id="cb14-3"><a></a>         <span class="at">duree_pjc_moins_5 =</span> <span class="fu">date_sub</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">5</span>)),</span>
<span id="cb14-4"><a></a>         <span class="at">duree_pjc_plus_1_mois =</span> <span class="fu">add_months</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Add_months</strong></p>
</div>
<div class="callout-content">
<p>Si la date en entrée est le dernier jour d’un mois, la date retournée avec <code>add_months(date_entree, int(1))</code> sera le dernier jour calendaire du mois suivant.</p>
</div>
</div>
</div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Format</strong></p>
</div>
<div class="callout-content">
<p>Le <code>int()</code> est important car ces fonctions Hive n’accepte que les entiers pour l’ajout de jours : taper uniquement 5 est considéré comme un flottant dans R.</p>
</div>
</div>
</div>
</div>
<div id="tabset-2-2">
<ul>
<li class="fragment"><p>Tri dans un groupe pour effectuer un calcul séquentiel</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a></a>ODD_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb15-2"><a></a>                                <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/odd.parquet"</span>,</span>
<span id="cb15-3"><a></a>                                <span class="at">memory =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-4"><a></a></span>
<span id="cb15-5"><a></a>ODD_premier <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a></a>  <span class="fu">group_by</span>(id_midas) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a></a>  <span class="fu">window_order</span>(id_midas, KDPOD) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a></a>  <span class="fu">mutate</span>(<span class="at">date_premier_droit =</span> <span class="fu">first</span>(KDPOD)) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a></a>  <span class="fu">distinct</span>(id_midas, KROD3, date_premier_droit) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Tri pour une sortie : <code>sdf_sort()</code> , <code>arrange()</code> ne fonctionne pas</p></li>
<li class="fragment"><p>Concaténer les lignes (ou les colonnes <code>sdf_bind_cols()</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a></a>ODD_1 <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a></a>  <span class="fu">filter</span>(KDPOD <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2017-12-31"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="st">"temoins"</span>)</span>
<span id="cb16-4"><a></a></span>
<span id="cb16-5"><a></a>ODD_2 <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a></a>  <span class="fu">filter</span>(KDPOD <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2021-12-31"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="st">"traites"</span>)</span>
<span id="cb16-8"><a></a></span>
<span id="cb16-9"><a></a>ODD_evaluation <span class="ot">&lt;-</span> <span class="fu">sdf_bind_rows</span>(ODD_1, ODD_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Dédoublonner une table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a></a>droits_dans_PJC <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a></a>  <span class="fu">sdf_distinct</span>(id_midas, KROD3)</span>
<span id="cb17-3"><a></a></span>
<span id="cb17-4"><a></a><span class="fu">print</span>(<span class="fu">head</span>(droits_dans_PJC, <span class="dv">5</span>))</span>
<span id="cb17-5"><a></a></span>
<span id="cb17-6"><a></a>PJC_dedoublonnee <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a></a>  <span class="fu">sdf_drop_duplicates</span>()</span>
<span id="cb17-8"><a></a></span>
<span id="cb17-9"><a></a><span class="fu">print</span>(<span class="fu">head</span>(PJC_dedoublonnee, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Pivot : les fonctions du packag <code>tidyr</code> ne fonctionnent pas sur données spark</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a></a>ODD_sjr_moyen <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="fu">ifelse</span>(KDPOD <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2020-12-31"</span>), <span class="st">"controles"</span>, <span class="st">"traites"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a></a>  <span class="fu">sdf_pivot</span>(groupe <span class="sc">~</span> KCRGC,</span>
<span id="cb18-4"><a></a>    <span class="at">fun.aggregate =</span> <span class="fu">list</span>(<span class="at">KQCSJP =</span> <span class="st">"mean"</span>)</span>
<span id="cb18-5"><a></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
</div>
<div id="tabset-2-3">
<ul>
<li class="fragment"><p>Résumé statistique : <code>sdf_describe()</code> , <code>summary()</code>ne fonctionne pas.</p></li>
<li class="fragment"><p>Dimension : <code>sdf_dim</code>, la fonction <code>nrow()</code>ne fonctionne pas.</p></li>
<li class="fragment"><p>Quantiles approximatifs : le calcul des quantiles sur données distirbuées renvoie une approximation car toutes les données ne peuvent pas être rappatriées sur la même machine physique du fait de la volumétrie, <code>sdf_quantile()</code></p></li>
<li class="fragment"><p>Echantillonnage aléatoire : <code>sdf_random_split</code></p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="quelques-tips-doptimisation" class="slide level2 smaller scrollable">
<h2>Quelques tips d’optimisation</h2>
<div class="panel-tabset">
<ul id="tabset-3" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-3-1">Jointures</a></li><li><a href="#tabset-3-2">Persist</a></li><li><a href="#tabset-3-3">Chargement</a></li><li><a href="#tabset-3-4">Export et partitions</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1">
<p>Pour effectuer ce type de jointure avec deux tables de volumétries différentes : A est petite, B est très volumineuse</p>
<p><img data-src="join.png"></p>
<p>Solution rapide :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a></a>table_finale <span class="ot">&lt;-</span> table_volumineuse_comme_PJC <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a></a>  <span class="fu">right_join</span>(petite_table_mon_champ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Solution lente :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a></a>table_finale <span class="ot">&lt;-</span> petite_table_mon_champ <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a></a>  <span class="fu">left_join</span>(table_volumineuse_comme_PJC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2">
<p>Lorsqu’une table intermédiaire est utilisée plusieurs fois dans un traitement, il est possible de la persister, c’est-à-dire enregistrer ce <code>spark_data_frame</code>sur le disque ou dans la mémoire des noeuds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a></a>table_1 <span class="ot">&lt;-</span> mon_champ <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a></a>  <span class="fu">left_join</span>(ODD, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id_midas"</span>, <span class="st">"KROD3"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a></a>  <span class="fu">rename</span>(<span class="at">duree_potentielle_indemnisation =</span> KPJDXP,</span>
<span id="cb21-4"><a></a>         <span class="at">SJR =</span> KQCSJP,</span>
<span id="cb21-5"><a></a>         <span class="at">date_debut_indemnisation =</span> KDPOD) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a></a>  <span class="fu">sdf_persist</span>()</span>
<span id="cb21-7"><a></a></span>
<span id="cb21-8"><a></a>duree <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a></a>  <span class="fu">summarise</span>(<span class="at">duree_moy =</span> <span class="fu">mean</span>(duree_potentielle_indemnisation),</span>
<span id="cb21-10"><a></a>            <span class="at">duree_med =</span> <span class="fu">median</span>(duree_potentielle_indemnisation)) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a></a>  <span class="fu">collect</span>()</span>
<span id="cb21-12"><a></a></span>
<span id="cb21-13"><a></a>SJR <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a></a>  <span class="fu">summarise</span>(<span class="at">SJR_moy =</span> <span class="fu">mean</span>(SJR),</span>
<span id="cb21-15"><a></a>            <span class="at">SJR_med =</span> <span class="fu">median</span>(SJR)) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-3">
<p>Lorsqu’on charge des données dans le cluster Spark et que la table est appelée plusieurs fois dans le programme, il est conseillé de la charger en mémoire vive directement.</p>
<p>Attention, si beaucoup de tables volumineuses sont chargées en mémoire, la fraction de la mémoire spark dédiée au stockage peut être insuffisante ou bien il peut ne pas rester assez de spark memory pour l’exécution.</p>
</div>
<div id="tabset-3-4">
<p>Le format <code>.parquet</code> (avec <code>arrow</code>) et le framework <code>spark</code> permettent de gérer le partitionnement des données.</p>
<p>Si les opérations sont souvent effectuées par régions par exemple, il est utile de forcer le stockage des données d’une même région au même endroit physique et accélère drastiquement le temps de calcul</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a></a><span class="fu">spark_write_parquet</span>(DE, <span class="at">partition_by =</span> <span class="fu">c</span>(<span class="st">"REGIND"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-warning callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Exports simultanés</strong></p>
</div>
<div class="callout-content">
<p>HDFS supporte les exports simultanés, mais le temp d’export est plus long lorsque le NameNode est requêté par plusieurs personnes simultanément : d’après les tests cluster</p>
<ul>
<li class="fragment"><p>pour un petit export (5 minutes), le temps peut être multiplié par 4 ;</p></li>
<li class="fragment"><p>pour un gros export (15 minutes), le temps peut être multiplié par 2.</p></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="forcer-le-calcul" class="slide level2 smaller">
<h2>Forcer le calcul</h2>
<p>Quelques actions :</p>
<ul>
<li class="fragment"><p>collecter la table entière 🛑</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>afficher les premières lignes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li class="fragment"><p>Mettre les donner en cache</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a></a>  <span class="fu">sdf_register</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a></a>  <span class="fu">tbl_cache</span>()</span>
<span id="cb25-4"><a></a></span>
<span id="cb25-5"><a></a>sc <span class="sc">%&gt;%</span> <span class="fu">spark_session</span>() <span class="sc">%&gt;%</span> <span class="fu">invoke</span>(<span class="st">"catalog"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a></a>  <span class="fu">invoke</span>(<span class="st">"clearCache"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
</section>
<section id="les-erreurs-en-sparklyr" class="slide level2 smaller">
<h2>Les erreurs en sparklyr</h2>
<p><code>sparklyr</code> traduit le code <code>dplyr</code> fourni en <code>scala</code>, mais interprète également les messages d’erreurs envoyés du cluster vers la session R.</p>
<p><code>sparklyr</code> n’est cependant pas performant pour interpréter ces erreurs.</p>
<p>N’hésitez pas à enregistrer le code générant un message d’erreur dans Documents publics/erreurs_sparklyr</p>
<p>Un test du code pas-à-pas permet d’isoler le problème.</p>
</section>
<section id="bonnes-pratiques" class="slide level2 smaller">
<h2>Bonnes pratiques</h2>
<ul>
<li class="fragment"><p>Déconnexion ou fermeture R pour libérer les ressources 🛑</p></li>
<li class="fragment"><p>Ne plus utiliser spark en local 🖥️🖥️🖥️</p></li>
<li class="fragment"><p>Pyspark ou Sparklyr pour la production ❓</p></li>
<li class="fragment"><p>Utilisation parcimonieuse des ressources ⚖️</p></li>
<li class="fragment"><p>Envoi des erreurs sparklyr 📩</p></li>
</ul>
</section></section>
<section>
<section id="pour-aller-plus-loin" class="title-slide slide level1 center">
<h1>Pour aller plus loin</h1>

</section>
<section id="larchitecture-map-reduce" class="slide level2">
<h2>L’architecture Map Reduce</h2>

<img data-src="map_reduce.png" class="r-stretch"></section>
<section id="la-gestion-de-la-mémoire-avec-spark" class="slide level2 smaller scrollable">
<h2>La gestion de la mémoire avec spark</h2>
<p>Les <strong>shuffles</strong> sont les opérations les plus gourmandes en temps.</p>
<div class="callout callout-note callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Qu’est-ce qu’un shuffle ?</strong></p>
</div>
<div class="callout-content">
<p>Un shuffle est un <strong>échange de données entre différents noeuds</strong> du cluster.</p>
<p>Nous avons vu qu’utiliser <code>spark</code> dans un cluster implique de distribuer également le stockage des données.</p>
<p>Par exemple :</p>
<ol type="1">
<li class="fragment"><p>je demande un traitement sur la table PJC du FNA</p></li>
<li class="fragment"><p>si un noeud contenant déjà les données de PJC est disponible, le cluster manager envoie le traitement à ce noeud</p></li>
<li class="fragment"><p>si tous les noeuds contenant les données de PJC sont déjà réservés, alors le cluster manager demande le traitement à un autre noeud, par exemple le noeud 1</p></li>
<li class="fragment"><p>il demande à un noeud contenant les données PJC, par exemple le noeud 4, d’envoyer ces données au noeud 1 qui va exécuter le traitement</p></li>
<li class="fragment"><p>cet échange de données est en réseau filaire : un échange filaire est beaucoup plus lent qu’un envoi interne par le disque du noeud 1 à la RAM du noeud 1</p></li>
<li class="fragment"><p>c’est pourquoi pour optimiser un programme spark, il est possible de limiter les shuffles</p></li>
</ol>
</div>
</div>
</div>
</section>
<section id="lutilisation-de-la-mémoire-dans-un-worker" class="slide level2 smaller scrollable">
<h2>L’utilisation de la mémoire dans un worker</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><img data-src="memoire_worker_1.drawio.png"></p>
</div><div class="column" style="width:50%;">
<p><img data-src="memoire_worker_2.drawio.png"></p>
</div></div>
<div class="callout callout-tip callout-titled callout-style-default">
<div class="callout-body">
<div class="callout-title">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<p><strong>Tip</strong></p>
</div>
<div class="callout-content">
<p>Ne pas charger plusieurs fois les mêmes données en cache, ou si besoin augmenter la part de la mémoire allouée au stockage avec <code>spark.memory.storageFraction</code>.</p>
</div>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb26" data-code-line-numbers="4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb26-2"><a></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb26-3"><a></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb26-4"><a></a>conf[<span class="st">"spark.memory.fraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb26-5"><a></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb26-6"><a></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb26-7"><a></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb26-8"><a></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-9"><a></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb26-10"><a></a></span>
<span id="cb26-11"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb27" data-code-line-numbers="5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb27-2"><a></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb27-3"><a></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb27-4"><a></a>conf[<span class="st">"spark.memory.fraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb27-5"><a></a>conf[<span class="st">"spark.memory.storageFraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb27-6"><a></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb27-7"><a></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb27-8"><a></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb27-9"><a></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-10"><a></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb27-11"><a></a></span>
<span id="cb27-12"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div></div>
</section>
<section id="sparkui-un-outil-doptimisation" class="slide level2 smaller scrollable">
<h2>SparkUI : un outil d’optimisation</h2>
<p>Spark UI permet de consulter le plan logique et physique du traitement demandé. Trois outils permettent d’optimiser les traitements :</p>
<div class="panel-tabset">
<ul id="tabset-4" class="panel-tabset-tabby"><li><a data-tabby-default="" href="#tabset-4-1">DAG</a></li><li><a href="#tabset-4-2">GC</a></li><li><a href="#tabset-4-3">Mémoire</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1">
<p><img data-src="dag.webp"></p>
</div>
<div id="tabset-4-2">
<p>Vérifier que le <code>gc time</code> est inférieur à 10% du temps pour exécuter la tâche ✅</p>
<p><img data-src="gc.png"></p>
</div>
<div id="tabset-4-3">
<p>Vérifier que la <code>storage memory</code> ne sature pas la mémoire ✅</p>
<p><img data-src="gc.png"></p>
</div>
</div>
</div>
</section>
<section id="utiliser-les-interfaces" class="slide level2 smaller">
<h2>Utiliser les interfaces</h2>
<ul>
<li class="fragment"><p><strong>yarn</strong> : disponibilité des ressources</p>
<p><img data-src="yarn_scheduler.PNG"></p></li>
<li class="fragment"><p><strong>Sparkhistory</strong> pour des traitements de sessions fermées</p></li>
</ul>
<p>Le sparkhistory entraîne l’enregistrement de logs assez lourdes, il est donc désactivé par défaut. Pour l’activer sur un programme :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb28-2"><a></a>conf[<span class="st">"spark.eventLog.enabled"</span>] <span class="ot">&lt;-</span> <span class="st">"true"</span></span>
<span id="cb28-3"><a></a>conf[<span class="st">"spark.eventLog.dir"</span>] <span class="ot">&lt;-</span> <span class="st">"hdfs://midares-deb11-nn-01.midares.local:9000/spark-logs"</span></span>
<span id="cb28-4"><a></a>conf[<span class="st">"appName"</span>] <span class="ot">&lt;-</span> <span class="st">"un_nom_de_traitement"</span></span>
<span id="cb28-5"><a></a></span>
<span id="cb28-6"><a></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ma-session-ne-sinstancie-jamais" class="slide level2 smaller">
<h2>Ma session ne s’instancie jamais</h2>
<p>Si l’instruction <code>sc &lt;- spark_connect(master = "yarn", config = conf</code> prend plus de 10 minutes, il est utile d’ouvrir l’interface de yarn pour vérifier que la file n’est pas déjà entièrement occupée. L’erreur peut ne survenir qu’au bout d’une vingtaine de minutes : le job est <code>ACCEPTED</code> dans yarn, ou <code>FAILED</code> si la session n’a pas pu être instanciée par manque de ressources disponibles.</p>

<img data-src="yarn_accepted.jpg" class="r-stretch"></section>
<section id="exporter-de-hdfs-au-local" class="slide level2 smaller">
<h2>Exporter de HDFS au local</h2>
<div class="r-stack">
<p><img data-src="hdfs_browse.png" class="fragment" width="1000" height="700"></p>
<p><img data-src="hdfs_download.png" class="fragment" width="1000" height="700"></p>
</div>
</section>
<section id="pyspark-mode-cluster" class="slide level2">
<h2>Pyspark : mode cluster</h2>

<img data-src="pyspark.drawio.png" class="r-stretch"></section>
<section id="les-avantages-de-pyspark" class="slide level2 smaller">
<h2>Les avantages de pyspark</h2>
<ul>
<li class="fragment"><p>Mode cluster : une machine du cluster peut prendre le rôle de driver 🖥️</p></li>
<li class="fragment"><p>Spark context dans le cluster : fermer sa session anaconda ne stoppe pas le traitement ♾️</p></li>
<li class="fragment"><p>Plusieurs sessions simultanées 👩‍💻👩‍💻👩‍💻</p></li>
<li class="fragment"><p>Stabilité : compatibilité assurée avec Apache Spark, problématique de production 🔄</p></li>
<li class="fragment"><p>Lisibilité du code 👓</p></li>
<li class="fragment"><p>Temps de connexion et d’exécution réduit ⏲️</p></li>
<li class="fragment"><p>Utilisation optimale de SparkUI 📊</p></li>
</ul>
</section>
<section id="merci-pour-votre-attention" class="slide level2">
<h2>Merci pour votre attention !</h2>

<div class="quarto-auto-generated-content">
<div class="footer footer-default">

</div>
</div>
</section></section>
    </div>
  </div>

  <script>window.backupDefine = window.define; window.define = undefined;</script>
  <script src="site_libs/revealjs/dist/reveal.js"></script>
  <!-- reveal.js plugins -->
  <script src="site_libs/revealjs/plugin/quarto-line-highlight/line-highlight.js"></script>
  <script src="site_libs/revealjs/plugin/pdf-export/pdfexport.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/menu.js"></script>
  <script src="site_libs/revealjs/plugin/reveal-menu/quarto-menu.js"></script>
  <script src="site_libs/revealjs/plugin/quarto-support/support.js"></script>
  

  <script src="site_libs/revealjs/plugin/notes/notes.js"></script>
  <script src="site_libs/revealjs/plugin/search/search.js"></script>
  <script src="site_libs/revealjs/plugin/zoom/zoom.js"></script>
  <script src="site_libs/revealjs/plugin/math/math.js"></script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script>

  <script>

      // Full list of configuration options available at:
      // https://revealjs.com/config/
      Reveal.initialize({
'controlsAuto': true,
'previewLinksAuto': false,
'pdfSeparateFragments': false,
'autoAnimateEasing': "ease",
'autoAnimateDuration': 1,
'autoAnimateUnmatched': true,
'menu': {"side":"left","useTextContentForMissingTitles":true,"markers":false,"loadIcons":false,"custom":[{"title":"Tools","icon":"<i class=\"fas fa-gear\"></i>","content":"<ul class=\"slide-menu-items\">\n<li class=\"slide-tool-item active\" data-item=\"0\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.fullscreen(event)\"><kbd>f</kbd> Fullscreen</a></li>\n<li class=\"slide-tool-item\" data-item=\"1\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.speakerMode(event)\"><kbd>s</kbd> Speaker View</a></li>\n<li class=\"slide-tool-item\" data-item=\"2\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.overview(event)\"><kbd>o</kbd> Slide Overview</a></li>\n<li class=\"slide-tool-item\" data-item=\"3\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.togglePdfExport(event)\"><kbd>e</kbd> PDF Export Mode</a></li>\n<li class=\"slide-tool-item\" data-item=\"4\"><a href=\"#\" onclick=\"RevealMenuToolHandlers.keyboardHelp(event)\"><kbd>?</kbd> Keyboard Help</a></li>\n</ul>"}],"openButton":true},
'smaller': false,
 
        // Display controls in the bottom right corner
        controls: false,

        // Help the user learn the controls by providing hints, for example by
        // bouncing the down arrow when they first encounter a vertical slide
        controlsTutorial: false,

        // Determines where controls appear, "edges" or "bottom-right"
        controlsLayout: 'edges',

        // Visibility rule for backwards navigation arrows; "faded", "hidden"
        // or "visible"
        controlsBackArrows: 'faded',

        // Display a presentation progress bar
        progress: true,

        // Display the page number of the current slide
        slideNumber: false,

        // 'all', 'print', or 'speaker'
        showSlideNumber: 'all',

        // Add the current slide number to the URL hash so that reloading the
        // page/copying the URL will return you to the same slide
        hash: true,

        // Start with 1 for the hash rather than 0
        hashOneBasedIndex: false,

        // Flags if we should monitor the hash and change slides accordingly
        respondToHashChanges: true,

        // Push each slide change to the browser history
        history: true,

        // Enable keyboard shortcuts for navigation
        keyboard: true,

        // Enable the slide overview mode
        overview: true,

        // Disables the default reveal.js slide layout (scaling and centering)
        // so that you can use custom CSS layout
        disableLayout: false,

        // Vertical centering of slides
        center: false,

        // Enables touch navigation on devices with touch input
        touch: true,

        // Loop the presentation
        loop: false,

        // Change the presentation direction to be RTL
        rtl: false,

        // see https://revealjs.com/vertical-slides/#navigation-mode
        navigationMode: 'linear',

        // Randomizes the order of slides each time the presentation loads
        shuffle: false,

        // Turns fragments on and off globally
        fragments: true,

        // Flags whether to include the current fragment in the URL,
        // so that reloading brings you to the same fragment position
        fragmentInURL: false,

        // Flags if the presentation is running in an embedded mode,
        // i.e. contained within a limited portion of the screen
        embedded: false,

        // Flags if we should show a help overlay when the questionmark
        // key is pressed
        help: true,

        // Flags if it should be possible to pause the presentation (blackout)
        pause: true,

        // Flags if speaker notes should be visible to all viewers
        showNotes: false,

        // Global override for autoplaying embedded media (null/true/false)
        autoPlayMedia: null,

        // Global override for preloading lazy-loaded iframes (null/true/false)
        preloadIframes: null,

        // Number of milliseconds between automatically proceeding to the
        // next slide, disabled when set to 0, this value can be overwritten
        // by using a data-autoslide attribute on your slides
        autoSlide: 0,

        // Stop auto-sliding after user input
        autoSlideStoppable: true,

        // Use this method for navigation when auto-sliding
        autoSlideMethod: null,

        // Specify the average time in seconds that you think you will spend
        // presenting each slide. This is used to show a pacing timer in the
        // speaker view
        defaultTiming: null,

        // Enable slide navigation via mouse wheel
        mouseWheel: false,

        // The display mode that will be used to show slides
        display: 'block',

        // Hide cursor if inactive
        hideInactiveCursor: true,

        // Time before the cursor is hidden (in ms)
        hideCursorTime: 5000,

        // Opens links in an iframe preview overlay
        previewLinks: false,

        // Transition style (none/fade/slide/convex/concave/zoom)
        transition: 'none',

        // Transition speed (default/fast/slow)
        transitionSpeed: 'default',

        // Transition style for full page slide backgrounds
        // (none/fade/slide/convex/concave/zoom)
        backgroundTransition: 'none',

        // Number of slides away from the current that are visible
        viewDistance: 3,

        // Number of slides away from the current that are visible on mobile
        // devices. It is advisable to set this to a lower number than
        // viewDistance in order to save resources.
        mobileViewDistance: 2,

        // The "normal" size of the presentation, aspect ratio will be preserved
        // when the presentation is scaled to fit different resolutions. Can be
        // specified using percentage units.
        width: 1050,

        height: 700,

        // Factor of the display size that should remain empty around the content
        margin: 0.1,

        math: {
          mathjax: 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js',
          config: 'TeX-AMS_HTML-full',
          tex2jax: {
            inlineMath: [['\\(','\\)']],
            displayMath: [['\\[','\\]']],
            balanceBraces: true,
            processEscapes: false,
            processRefs: true,
            processEnvironments: true,
            preview: 'TeX',
            skipTags: ['script','noscript','style','textarea','pre','code'],
            ignoreClass: 'tex2jax_ignore',
            processClass: 'tex2jax_process'
          },
        },

        // reveal.js plugins
        plugins: [QuartoLineHighlight, PdfExport, RevealMenu, QuartoSupport,

          RevealMath,
          RevealNotes,
          RevealSearch,
          RevealZoom
        ]
      });
    </script>
    
    <script>
      // htmlwidgets need to know to resize themselves when slides are shown/hidden.
      // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
      // slide changes (different for each slide format).
      (function () {
        // dispatch for htmlwidgets
        function fireSlideEnter() {
          const event = window.document.createEvent("Event");
          event.initEvent("slideenter", true, true);
          window.document.dispatchEvent(event);
        }

        function fireSlideChanged(previousSlide, currentSlide) {
          fireSlideEnter();

          // dispatch for shiny
          if (window.jQuery) {
            if (previousSlide) {
              window.jQuery(previousSlide).trigger("hidden");
            }
            if (currentSlide) {
              window.jQuery(currentSlide).trigger("shown");
            }
          }
        }

        // hookup for slidy
        if (window.w3c_slidy) {
          window.w3c_slidy.add_observer(function (slide_num) {
            // slide_num starts at position 1
            fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
          });
        }

      })();
    </script>

    <script id="quarto-html-after-body" type="application/javascript">
    window.document.addEventListener("DOMContentLoaded", function (event) {
      const toggleBodyColorMode = (bsSheetEl) => {
        const mode = bsSheetEl.getAttribute("data-mode");
        const bodyEl = window.document.querySelector("body");
        if (mode === "dark") {
          bodyEl.classList.add("quarto-dark");
          bodyEl.classList.remove("quarto-light");
        } else {
          bodyEl.classList.add("quarto-light");
          bodyEl.classList.remove("quarto-dark");
        }
      }
      const toggleBodyColorPrimary = () => {
        const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
        if (bsSheetEl) {
          toggleBodyColorMode(bsSheetEl);
        }
      }
      toggleBodyColorPrimary();  
      const tabsets =  window.document.querySelectorAll(".panel-tabset-tabby")
      tabsets.forEach(function(tabset) {
        const tabby = new Tabby('#' + tabset.id);
      });
      const isCodeAnnotation = (el) => {
        for (const clz of el.classList) {
          if (clz.startsWith('code-annotation-')) {                     
            return true;
          }
        }
        return false;
      }
      const onCopySuccess = function(e) {
        // button target
        const button = e.trigger;
        // don't keep focus
        button.blur();
        // flash "checked"
        button.classList.add('code-copy-button-checked');
        var currentTitle = button.getAttribute("title");
        button.setAttribute("title", "Copied!");
        let tooltip;
        if (window.bootstrap) {
          button.setAttribute("data-bs-toggle", "tooltip");
          button.setAttribute("data-bs-placement", "left");
          button.setAttribute("data-bs-title", "Copied!");
          tooltip = new bootstrap.Tooltip(button, 
            { trigger: "manual", 
              customClass: "code-copy-button-tooltip",
              offset: [0, -8]});
          tooltip.show();    
        }
        setTimeout(function() {
          if (tooltip) {
            tooltip.hide();
            button.removeAttribute("data-bs-title");
            button.removeAttribute("data-bs-toggle");
            button.removeAttribute("data-bs-placement");
          }
          button.setAttribute("title", currentTitle);
          button.classList.remove('code-copy-button-checked');
        }, 1000);
        // clear code selection
        e.clearSelection();
      }
      const getTextToCopy = function(trigger) {
          const codeEl = trigger.previousElementSibling.cloneNode(true);
          for (const childEl of codeEl.children) {
            if (isCodeAnnotation(childEl)) {
              childEl.remove();
            }
          }
          return codeEl.innerText;
      }
      const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
        text: getTextToCopy
      });
      clipboard.on('success', onCopySuccess);
      if (window.document.getElementById('quarto-embedded-source-code-modal')) {
        // For code content inside modals, clipBoardJS needs to be initialized with a container option
        // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
        const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
          text: getTextToCopy,
          container: window.document.getElementById('quarto-embedded-source-code-modal')
        });
        clipboardModal.on('success', onCopySuccess);
      }
        var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
        var mailtoRegex = new RegExp(/^mailto:/);
          var filterRegex = new RegExp("https:\/\/leoniefvr\.github\.io\/Formation_spark\/");
        var isInternal = (href) => {
            return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
        }
        // Inspect non-navigation links and adorn them if external
     	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
        for (var i=0; i<links.length; i++) {
          const link = links[i];
          if (!isInternal(link.href)) {
            // undo the damage that might have been done by quarto-nav.js in the case of
            // links that we want to consider external
            if (link.dataset.originalHref !== undefined) {
              link.href = link.dataset.originalHref;
            }
          }
        }
      function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
        const config = {
          allowHTML: true,
          maxWidth: 500,
          delay: 100,
          arrow: false,
          appendTo: function(el) {
              return el.closest('section.slide') || el.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'light-border',
          placement: 'bottom-start',
        };
        if (contentFn) {
          config.content = contentFn;
        }
        if (onTriggerFn) {
          config.onTrigger = onTriggerFn;
        }
        if (onUntriggerFn) {
          config.onUntrigger = onUntriggerFn;
        }
          config['offset'] = [0,0];
          config['maxWidth'] = 700;
        window.tippy(el, config); 
      }
      const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
      for (var i=0; i<noterefs.length; i++) {
        const ref = noterefs[i];
        tippyHover(ref, function() {
          // use id or data attribute instead here
          let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
          try { href = new URL(href).hash; } catch {}
          const id = href.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note) {
            return note.innerHTML;
          } else {
            return "";
          }
        });
      }
      const findCites = (el) => {
        const parentEl = el.parentElement;
        if (parentEl) {
          const cites = parentEl.dataset.cites;
          if (cites) {
            return {
              el,
              cites: cites.split(' ')
            };
          } else {
            return findCites(el.parentElement)
          }
        } else {
          return undefined;
        }
      };
      var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
      for (var i=0; i<bibliorefs.length; i++) {
        const ref = bibliorefs[i];
        const citeInfo = findCites(ref);
        if (citeInfo) {
          tippyHover(citeInfo.el, function() {
            var popup = window.document.createElement('div');
            citeInfo.cites.forEach(function(cite) {
              var citeDiv = window.document.createElement('div');
              citeDiv.classList.add('hanging-indent');
              citeDiv.classList.add('csl-entry');
              var biblioDiv = window.document.getElementById('ref-' + cite);
              if (biblioDiv) {
                citeDiv.innerHTML = biblioDiv.innerHTML;
              }
              popup.appendChild(citeDiv);
            });
            return popup.innerHTML;
          });
        }
      }
    });
    </script>
    

</body></html>