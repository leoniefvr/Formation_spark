<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Formation sparklyr - Initiation √† Spark avec R en mode cluster</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-sidebar docked">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title">Initiation √† Spark avec R en mode cluster</h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation docked overflow-auto">
    <div class="pt-lg-2 mt-2 text-center sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Formation sparklyr</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">Introduction</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./slides_v.html" class="sidebar-item-text sidebar-link">Slides</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./configuration.html" class="sidebar-item-text sidebar-link">Configuration</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./fonctions_specifiques.html" class="sidebar-item-text sidebar-link">Fonctions sp√©cifiques √† sparklyr</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./dates.html" class="sidebar-item-text sidebar-link">Les dates avec sparklyr</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./oom.html" class="sidebar-item-text sidebar-link">Out of memory : help !</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./errors.html" class="sidebar-item-text sidebar-link">Guide des erreurs</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./bonnes_pratiques.html" class="sidebar-item-text sidebar-link">Bonnes pratiques</a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./ressources.html" class="sidebar-item-text sidebar-link">Ressources</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#au-programme" id="toc-au-programme" class="nav-link active" data-scroll-target="#au-programme">Au programme</a></li>
  <li><a href="#midas-une-base-de-donn√©es-volumineuse" id="toc-midas-une-base-de-donn√©es-volumineuse" class="nav-link" data-scroll-target="#midas-une-base-de-donn√©es-volumineuse">MiDAS : une base de donn√©es volumineuse</a></li>
  <li><a href="#midas-une-base-de-donn√©es-volumineuse-1" id="toc-midas-une-base-de-donn√©es-volumineuse-1" class="nav-link" data-scroll-target="#midas-une-base-de-donn√©es-volumineuse-1">MiDAS : une base de donn√©es volumineuse</a></li>
  <li><a href="#midas-une-base-de-donn√©es-volumineuse-2" id="toc-midas-une-base-de-donn√©es-volumineuse-2" class="nav-link" data-scroll-target="#midas-une-base-de-donn√©es-volumineuse-2">MiDAS : une base de donn√©es volumineuse</a></li>
  <li><a href="#structure-de-lappariement" id="toc-structure-de-lappariement" class="nav-link" data-scroll-target="#structure-de-lappariement">Structure de l‚Äôappariement</a></li>
  <li><a href="#le-format-parquet" id="toc-le-format-parquet" class="nav-link" data-scroll-target="#le-format-parquet">Le format parquet</a></li>
  <li><a href="#manipuler-un-appariement-une-op√©ration-co√ªteuse" id="toc-manipuler-un-appariement-une-op√©ration-co√ªteuse" class="nav-link" data-scroll-target="#manipuler-un-appariement-une-op√©ration-co√ªteuse">Manipuler un appariement : une op√©ration co√ªteuse</a>
  <ul class="collapse">
  <li><a href="#lespace-midares" id="toc-lespace-midares" class="nav-link" data-scroll-target="#lespace-midares">L‚Äôespace MiDares</a></li>
  <li><a href="#programmer-en-m√©moire-vive" id="toc-programmer-en-m√©moire-vive" class="nav-link" data-scroll-target="#programmer-en-m√©moire-vive">Programmer en m√©moire vive</a></li>
  <li><a href="#les-traitements-co√ªteux-en-puissance-de-calcul" id="toc-les-traitements-co√ªteux-en-puissance-de-calcul" class="nav-link" data-scroll-target="#les-traitements-co√ªteux-en-puissance-de-calcul">Les traitements co√ªteux en puissance de calcul</a></li>
  <li><a href="#un-traitement-peu-co√ªteux-un-traitement-map" id="toc-un-traitement-peu-co√ªteux-un-traitement-map" class="nav-link" data-scroll-target="#un-traitement-peu-co√ªteux-un-traitement-map">Un traitement peu co√ªteux : un traitement MAP</a></li>
  <li><a href="#un-traitement-co√ªteux-un-traitement-reduce" id="toc-un-traitement-co√ªteux-un-traitement-reduce" class="nav-link" data-scroll-target="#un-traitement-co√ªteux-un-traitement-reduce">Un traitement co√ªteux : un traitement REDUCE</a></li>
  </ul></li>
  <li><a href="#initiation-au-calcul-distribu√©" id="toc-initiation-au-calcul-distribu√©" class="nav-link" data-scroll-target="#initiation-au-calcul-distribu√©">Initiation au calcul distribu√©</a>
  <ul class="collapse">
  <li><a href="#calcul-distribu√©-et-calcul-parall√®le" id="toc-calcul-distribu√©-et-calcul-parall√®le" class="nav-link" data-scroll-target="#calcul-distribu√©-et-calcul-parall√®le">Calcul distribu√© et calcul parall√®le</a></li>
  <li><a href="#un-traitement-map-distribu√©" id="toc-un-traitement-map-distribu√©" class="nav-link" data-scroll-target="#un-traitement-map-distribu√©">Un traitement MAP distribu√©</a></li>
  <li><a href="#un-traitement-reduce-distribu√©" id="toc-un-traitement-reduce-distribu√©" class="nav-link" data-scroll-target="#un-traitement-reduce-distribu√©">Un traitement REDUCE distribu√©</a></li>
  <li><a href="#spark" id="toc-spark" class="nav-link" data-scroll-target="#spark">Spark</a></li>
  <li><a href="#installation-de-spark-sous-casd" id="toc-installation-de-spark-sous-casd" class="nav-link" data-scroll-target="#installation-de-spark-sous-casd">Installation de spark sous CASD</a></li>
  <li><a href="#la-machine-virtuelle-java" id="toc-la-machine-virtuelle-java" class="nav-link" data-scroll-target="#la-machine-virtuelle-java">La machine virtuelle Java</a></li>
  <li><a href="#deux-mani√®res-dutiliser-spark" id="toc-deux-mani√®res-dutiliser-spark" class="nav-link" data-scroll-target="#deux-mani√®res-dutiliser-spark">Deux mani√®res d‚Äôutiliser Spark</a></li>
  <li><a href="#mode-local-sch√©ma" id="toc-mode-local-sch√©ma" class="nav-link" data-scroll-target="#mode-local-sch√©ma">Mode local : sch√©ma</a></li>
  <li><a href="#mode-local-√†-√©viter" id="toc-mode-local-√†-√©viter" class="nav-link" data-scroll-target="#mode-local-√†-√©viter">Mode local : √† √©viter</a></li>
  <li><a href="#le-cluster-de-calcul-midares-pr√©sentation" id="toc-le-cluster-de-calcul-midares-pr√©sentation" class="nav-link" data-scroll-target="#le-cluster-de-calcul-midares-pr√©sentation">Le cluster de calcul Midares : pr√©sentation</a></li>
  <li><a href="#se-connecter-√†-spark-sur-un-cluster" id="toc-se-connecter-√†-spark-sur-un-cluster" class="nav-link" data-scroll-target="#se-connecter-√†-spark-sur-un-cluster">Se connecter √† Spark sur un cluster</a></li>
  <li><a href="#une-connexion" id="toc-une-connexion" class="nav-link" data-scroll-target="#une-connexion">Une connexion</a></li>
  <li><a href="#la-vie-dun-programme-r√©dig√©-en-sparklyr" id="toc-la-vie-dun-programme-r√©dig√©-en-sparklyr" class="nav-link" data-scroll-target="#la-vie-dun-programme-r√©dig√©-en-sparklyr">La vie d‚Äôun programme r√©dig√© en sparklyr</a></li>
  <li><a href="#la-lazy-evaluation" id="toc-la-lazy-evaluation" class="nav-link" data-scroll-target="#la-lazy-evaluation">La lazy evaluation</a></li>
  <li><a href="#la-vie-dun-programme-r√©dig√©-en-sparklyr-1" id="toc-la-vie-dun-programme-r√©dig√©-en-sparklyr-1" class="nav-link" data-scroll-target="#la-vie-dun-programme-r√©dig√©-en-sparklyr-1">La vie d‚Äôun programme r√©dig√© en sparklyr</a></li>
  <li><a href="#le-r√¥le-du-driver" id="toc-le-r√¥le-du-driver" class="nav-link" data-scroll-target="#le-r√¥le-du-driver">Le r√¥le du driver</a></li>
  <li><a href="#le-plan-dex√©cution" id="toc-le-plan-dex√©cution" class="nav-link" data-scroll-target="#le-plan-dex√©cution">Le plan d‚Äôex√©cution</a></li>
  <li><a href="#le-r√¥le-du-driver-catalyst" id="toc-le-r√¥le-du-driver-catalyst" class="nav-link" data-scroll-target="#le-r√¥le-du-driver-catalyst">Le r√¥le du driver : Catalyst</a></li>
  <li><a href="#le-r√¥le-du-driver-catalyst-1" id="toc-le-r√¥le-du-driver-catalyst-1" class="nav-link" data-scroll-target="#le-r√¥le-du-driver-catalyst-1">Le r√¥le du driver : Catalyst</a></li>
  <li><a href="#le-r√¥le-du-driver-catalyst-2" id="toc-le-r√¥le-du-driver-catalyst-2" class="nav-link" data-scroll-target="#le-r√¥le-du-driver-catalyst-2">Le r√¥le du driver : Catalyst</a></li>
  <li><a href="#le-r√¥le-du-cluster-manager" id="toc-le-r√¥le-du-cluster-manager" class="nav-link" data-scroll-target="#le-r√¥le-du-cluster-manager">Le r√¥le du cluster manager</a></li>
  <li><a href="#le-r√¥le-du-worker" id="toc-le-r√¥le-du-worker" class="nav-link" data-scroll-target="#le-r√¥le-du-worker">Le r√¥le du worker</a></li>
  <li><a href="#o√π-sont-les-donn√©es" id="toc-o√π-sont-les-donn√©es" class="nav-link" data-scroll-target="#o√π-sont-les-donn√©es">O√π sont les donn√©es ?</a></li>
  <li><a href="#o√π-sont-les-donn√©es-1" id="toc-o√π-sont-les-donn√©es-1" class="nav-link" data-scroll-target="#o√π-sont-les-donn√©es-1">O√π sont les donn√©es ?</a></li>
  <li><a href="#transfert-de-la-bulle-√†-hdfs" id="toc-transfert-de-la-bulle-√†-hdfs" class="nav-link" data-scroll-target="#transfert-de-la-bulle-√†-hdfs">Transfert de la bulle √† HDFS</a></li>
  <li><a href="#transfert-de-hdfs-√†-la-bulle" id="toc-transfert-de-hdfs-√†-la-bulle" class="nav-link" data-scroll-target="#transfert-de-hdfs-√†-la-bulle">Transfert de HDFS √† la bulle</a></li>
  <li><a href="#mais-o√π-sont-r√©ellement-les-donn√©es-hdfs" id="toc-mais-o√π-sont-r√©ellement-les-donn√©es-hdfs" class="nav-link" data-scroll-target="#mais-o√π-sont-r√©ellement-les-donn√©es-hdfs">Mais o√π sont r√©ellement les donn√©es ? HDFS</a></li>
  </ul></li>
  <li><a href="#programmer-avec-sparklyr" id="toc-programmer-avec-sparklyr" class="nav-link" data-scroll-target="#programmer-avec-sparklyr">Programmer avec sparklyr</a>
  <ul class="collapse">
  <li><a href="#param√©trer-sa-session" id="toc-param√©trer-sa-session" class="nav-link" data-scroll-target="#param√©trer-sa-session">Param√©trer sa session</a></li>
  <li><a href="#mode-cluster-non-concurrence-gr√¢ce-au-cluster-manager" id="toc-mode-cluster-non-concurrence-gr√¢ce-au-cluster-manager" class="nav-link" data-scroll-target="#mode-cluster-non-concurrence-gr√¢ce-au-cluster-manager">Mode cluster : non concurrence gr√¢ce au cluster manager</a></li>
  <li><a href="#importer-les-donn√©es-depuis-hdfs-sous-r" id="toc-importer-les-donn√©es-depuis-hdfs-sous-r" class="nav-link" data-scroll-target="#importer-les-donn√©es-depuis-hdfs-sous-r">Importer les donn√©es depuis HDFS sous R</a></li>
  <li><a href="#les-exports-sur-hdfs" id="toc-les-exports-sur-hdfs" class="nav-link" data-scroll-target="#les-exports-sur-hdfs">Les exports sur HDFS</a></li>
  <li><a href="#les-shuffles" id="toc-les-shuffles" class="nav-link" data-scroll-target="#les-shuffles">Les shuffles</a></li>
  <li><a href="#r√©cup√©rer-un-r√©sultat" id="toc-r√©cup√©rer-un-r√©sultat" class="nav-link" data-scroll-target="#r√©cup√©rer-un-r√©sultat">R√©cup√©rer un r√©sultat</a></li>
  <li><a href="#lutilisation-de-la-m√©moire-du-driver" id="toc-lutilisation-de-la-m√©moire-du-driver" class="nav-link" data-scroll-target="#lutilisation-de-la-m√©moire-du-driver">L‚Äôutilisation de la m√©moire du driver</a></li>
  <li><a href="#lutilisation-de-la-m√©moire-du-driver-1" id="toc-lutilisation-de-la-m√©moire-du-driver-1" class="nav-link" data-scroll-target="#lutilisation-de-la-m√©moire-du-driver-1">L‚Äôutilisation de la m√©moire du driver</a></li>
  <li><a href="#comment-tester-son-code-pour-collecter-le-moins-possible" id="toc-comment-tester-son-code-pour-collecter-le-moins-possible" class="nav-link" data-scroll-target="#comment-tester-son-code-pour-collecter-le-moins-possible">Comment tester son code pour collecter le moins possible ?</a></li>
  </ul></li>
  <li><a href="#sparklyr-la-solution-ergonomique-de-spark-sous-r" id="toc-sparklyr-la-solution-ergonomique-de-spark-sous-r" class="nav-link" data-scroll-target="#sparklyr-la-solution-ergonomique-de-spark-sous-r">Sparklyr : la solution ergonomique de spark sous R</a>
  <ul class="collapse">
  <li><a href="#ce-qui-change-pour-lutilisateur" id="toc-ce-qui-change-pour-lutilisateur" class="nav-link" data-scroll-target="#ce-qui-change-pour-lutilisateur">Ce qui change pour l‚Äôutilisateur</a></li>
  <li><a href="#quelques-fonctions-sp√©cifiques" id="toc-quelques-fonctions-sp√©cifiques" class="nav-link" data-scroll-target="#quelques-fonctions-sp√©cifiques">Quelques fonctions sp√©cifiques</a></li>
  <li><a href="#quelques-tips-doptimisation" id="toc-quelques-tips-doptimisation" class="nav-link" data-scroll-target="#quelques-tips-doptimisation">Quelques tips d‚Äôoptimisation</a></li>
  <li><a href="#forcer-le-calcul" id="toc-forcer-le-calcul" class="nav-link" data-scroll-target="#forcer-le-calcul">Forcer le calcul</a></li>
  <li><a href="#les-erreurs-en-sparklyr" id="toc-les-erreurs-en-sparklyr" class="nav-link" data-scroll-target="#les-erreurs-en-sparklyr">Les erreurs en sparklyr</a></li>
  <li><a href="#bonnes-pratiques" id="toc-bonnes-pratiques" class="nav-link" data-scroll-target="#bonnes-pratiques">Bonnes pratiques</a></li>
  </ul></li>
  <li><a href="#pour-aller-plus-loin" id="toc-pour-aller-plus-loin" class="nav-link" data-scroll-target="#pour-aller-plus-loin">Pour aller plus loin</a>
  <ul class="collapse">
  <li><a href="#larchitecture-map-reduce" id="toc-larchitecture-map-reduce" class="nav-link" data-scroll-target="#larchitecture-map-reduce">L‚Äôarchitecture Map Reduce</a></li>
  <li><a href="#la-gestion-de-la-m√©moire-avec-spark" id="toc-la-gestion-de-la-m√©moire-avec-spark" class="nav-link" data-scroll-target="#la-gestion-de-la-m√©moire-avec-spark">La gestion de la m√©moire avec spark</a></li>
  <li><a href="#lutilisation-de-la-m√©moire-dans-un-worker" id="toc-lutilisation-de-la-m√©moire-dans-un-worker" class="nav-link" data-scroll-target="#lutilisation-de-la-m√©moire-dans-un-worker">L‚Äôutilisation de la m√©moire dans un worker</a></li>
  <li><a href="#sparkui-un-outil-doptimisation" id="toc-sparkui-un-outil-doptimisation" class="nav-link" data-scroll-target="#sparkui-un-outil-doptimisation">SparkUI : un outil d‚Äôoptimisation</a></li>
  <li><a href="#utiliser-les-interfaces" id="toc-utiliser-les-interfaces" class="nav-link" data-scroll-target="#utiliser-les-interfaces">Utiliser les interfaces</a></li>
  <li><a href="#ma-session-ne-sinstancie-jamais" id="toc-ma-session-ne-sinstancie-jamais" class="nav-link" data-scroll-target="#ma-session-ne-sinstancie-jamais">Ma session ne s‚Äôinstancie jamais</a></li>
  <li><a href="#exporter-de-hdfs-au-local" id="toc-exporter-de-hdfs-au-local" class="nav-link" data-scroll-target="#exporter-de-hdfs-au-local">Exporter de HDFS au local</a></li>
  <li><a href="#pyspark-mode-cluster" id="toc-pyspark-mode-cluster" class="nav-link" data-scroll-target="#pyspark-mode-cluster">Pyspark : mode cluster</a></li>
  <li><a href="#les-avantages-de-pyspark" id="toc-les-avantages-de-pyspark" class="nav-link" data-scroll-target="#les-avantages-de-pyspark">Les avantages de pyspark</a></li>
  <li><a href="#merci-pour-votre-attention" id="toc-merci-pour-votre-attention" class="nav-link" data-scroll-target="#merci-pour-votre-attention">Merci pour votre attention !</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block">Initiation √† Spark avec R en mode cluster</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="au-programme" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="au-programme">Au programme</h2>
<ol type="1">
<li><p>MiDAS : une base de donn√©es volumineuse üíæ</p></li>
<li><p>Manipuler un appariement : une op√©ration co√ªteuse üí≤</p></li>
<li><p>Initiation au calcul distribu√© : quelles ressources r√©server ? üñ•Ô∏èüñ•Ô∏èüñ•Ô∏è</p></li>
<li><p>Sparklyr : la solution ergonomique de spark sous R üë®‚Äçüíª</p></li>
<li><p>Pour aller plus loin ‚è©</p></li>
</ol>
</section>
<section id="midas-une-base-de-donn√©es-volumineuse" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="midas-une-base-de-donn√©es-volumineuse">MiDAS : une base de donn√©es volumineuse</h2>
<p>MiDAS croise trois bases de donn√©es administratives exhaustives :</p>
<ul>
<li><p>les donn√©es sur <strong>l‚Äôinscription et l‚Äôindemnisation des demandeurs d‚Äôemploi</strong> de France Travail : le Fichier Historique Statistique (FHS) et le Fichier National des Allocataires (FNA) ;</p></li>
<li><p>les donn√©es sur les b√©n√©ficiaires de <strong>minima sociaux</strong> (RSA, PPA, AAH) et les caract√©ristiques des <strong>m√©nages</strong> de la CNAF : Allstat-FR6 ;</p></li>
<li><p>les donn√©es sur les <strong>contrats salari√©s</strong> de la DSN : MMO de la Dares.</p></li>
</ul>
</section>
<section id="midas-une-base-de-donn√©es-volumineuse-1" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="midas-une-base-de-donn√©es-volumineuse-1">MiDAS : une base de donn√©es volumineuse</h2>
<p>Chaque vague de MiDAS correspond √† environ <strong>600 Go</strong> de donn√©es au format sas. Les vagues fonctionnent par empilement :</p>
<ul>
<li><p>le gain de <strong>profondeur temporelle</strong> et l‚Äôentr√©e dans le champ de nouvelles personnes</p></li>
<li><p>les <strong>vagues sont appariables entre elles</strong></p></li>
</ul>
</section>
<section id="midas-une-base-de-donn√©es-volumineuse-2" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="midas-une-base-de-donn√©es-volumineuse-2">MiDAS : une base de donn√©es volumineuse</h2>
<p>MiDAS est l‚Äôune des bases de donn√©es les plus volumineuses du SSP :<img src="donnees_ssp.PNG" class="img-fluid" alt="Quelques bases du SSP"></p>
<p>Les administrations dont les donn√©es sont comparables √† MiDAS utilisent un cluster Spark : Insee, Drees, Acoss‚Ä¶</p>
<p>‚ñ∂Ô∏èLe cluster spark est la solution la plus efficiente pour traiter des donn√©es de cette ampleur. Apprendre √† l‚Äôutiliser pourra vous √™tre utile dans d‚Äôautres contextes que celui de la Dares.</p>
</section>
<section id="structure-de-lappariement" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="structure-de-lappariement">Structure de l‚Äôappariement</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="structure_midas.PNG" class="img-fluid figure-img"></p>
</figure>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Pourquoi Spark ?
</div>
</div>
<div class="callout-body-container callout-body">
<p>La manipulation des donn√©es MiDAS en l‚Äô√©tat implique de nombreuses op√©rations de jointures qui n√©cessitent une puissance de calcul et un temps certains.</p>
</div>
</div>
</section>
<section id="le-format-parquet" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="le-format-parquet">Le format parquet</h2>
<p>Les donn√©es sont converties au <strong>format parquet</strong> d√®s leur r√©ception et mises √† disposition sur la bulle CASD du projet MiDares sous l‚Äôespace commun. Le format parquet est un format de donn√©es adapt√© aux donn√©es volumineuses :</p>
<ul>
<li><p>il <strong>compresse</strong> efficacement les donn√©es : taux de compression de 5 √† 10 par rapport au format csv</p></li>
<li><p>il est orient√© <strong>colonnes</strong></p></li>
<li><p>il permet le chargement efficace <strong>en m√©moire</strong> des donn√©es</p></li>
<li><p>Il permet le <strong>stockage partitionn√©</strong> des donn√©es</p></li>
<li><p>il permet un traitement de cette partition qui conserve les donn√©es non n√©cessaires <strong>sur disque</strong></p></li>
<li><p>Il est <strong>ind√©pendant du logiciel</strong> utilis√© : il peut donc √™tre trait√© par spark et par R.</p></li>
</ul>
</section>
<section id="manipuler-un-appariement-une-op√©ration-co√ªteuse" class="level1">
<h1>Manipuler un appariement : une op√©ration co√ªteuse</h1>
<section id="lespace-midares" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="lespace-midares">L‚Äôespace MiDares</h2>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Ressources</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Sch√©ma</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p>Des ressources partag√©es entre tous les utilsateurs simultan√©s :</p>
<ul>
<li>512 Go de m√©moire vive (ou RAM) : passage √† 256 Go</li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
La m√©moire vive
</div>
</div>
<div class="callout-body-container callout-body">
<p>La m√©moire vive, aussi appel√©e RAM, se distingue de la m√©moire de stockage (disque) par sa <strong>rapidit√©</strong>, notamment pour fournir des donn√©es au processeur pour effectuer des calculs, par sa <strong>volatilit√©</strong> (toutes les donn√©es sont perdues si l‚Äôordinateur n‚Äôest plus aliment√©) et par l‚Äôacc√®s direct aux informations qui y sont stock√©es, <strong>quasi instantann√©</strong>.</p>
</div>
</div>
<ul>
<li>Un processeur (ou CPU) compos√© de 32 coeurs : passage √† 16 coeurs</li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Le processeur
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le processeur permet d‚Äô<strong>ex√©cuter des t√¢ches et des programmes</strong> : convertir un fichier, ex√©cuter un logiciel‚Ä¶ Il est compos√© d‚Äôun ou de plusieurs <strong>coeurs</strong> : un coeur ne peut ex√©cuter qu‚Äôune seule t√¢che √† la fois. Si le processeur contient plusieurs coeurs, il peut ex√©cuter autant de t√¢ches en parall√®le qu‚Äôil a de coeurs. Un processeur se caract√©rise aussi par sa <strong>fr√©quence</strong> : elle est globalement proportionnelle au nombre d‚Äôop√©rations qu‚Äôil est capable d‚Äôeffetuer par seconde.</p>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p><img src="schema_ordinateur.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="programmer-en-m√©moire-vive" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="programmer-en-m√©moire-vive">Programmer en m√©moire vive</h2>
<ul>
<li><p><strong>R : la m√©moire vive, √©tat dans l‚Äôenvironnement</strong></p></li>
<li><p>SAS : lecture/√©criture sur le disque</p></li>
<li><p>MiDAS au format sas &gt;&gt; taille de la m√©moire vive disponible du serveur CASD ‚Äì&gt; format <code>.parquet</code></p></li>
<li><p><strong>Impossible de charger tout MiDAS en m√©moire vive</strong></p>
<p>Des solutions existent pour manipuler les donn√©es sous R sans les charger enti√®rement en m√©moire vive :</p></li>
<li><p><code>arrow</code> (avec des requ√™tes <code>dplyr</code>)</p></li>
<li><p><code>duckDB</code> : recommand√© par le SSPLab pour des donn√©es jusqu‚Äô√† 100Go</p>
<p>‚ñ∂Ô∏è Insuffisantes pour les traitements les plus co√ªteux sur MiDAS en R : la partie de la m√©moire vive utilis√©e pour stocker les donn√©es correspond √† autant de puissance de calcul indisponible pour les traitements.</p></li>
</ul>
</section>
<section id="les-traitements-co√ªteux-en-puissance-de-calcul" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="les-traitements-co√ªteux-en-puissance-de-calcul">Les traitements co√ªteux en puissance de calcul</h2>
<ul>
<li><p>les jointures</p></li>
<li><p>les op√©rations en <code>group_by()</code></p></li>
<li><p><code>distinct()</code></p>
<p>‚ñ∂Ô∏è Ex√©cution s√©quentielle sur un coeur du processeur + beaucoup de m√©moire vive (donn√©es temporaires)</p>
<p>‚ñ∂Ô∏è Erreur ‚Äúout of memory‚Äù.</p></li>
</ul>
</section>
<section id="un-traitement-peu-co√ªteux-un-traitement-map" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="un-traitement-peu-co√ªteux-un-traitement-map">Un traitement peu co√ªteux : un traitement MAP</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="formation sparklyr-Page-1.drawio.png" class="img-fluid figure-img" width="800"></p>
</figure>
</div>
<p>Ce traitement est peu co√ªteux :</p>
<ul>
<li><p>chargement d‚Äôune seule colonne en RAM : format parquet orient√© colonnes</p></li>
<li><p>peu de m√©moire d‚Äôex√©cution : R est un langage vectoris√©</p></li>
</ul>
</section>
<section id="un-traitement-co√ªteux-un-traitement-reduce" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="un-traitement-co√ªteux-un-traitement-reduce">Un traitement co√ªteux : un traitement REDUCE</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="formation sparklyr-Page-2.drawio.png" class="img-fluid figure-img" width="850"></p>
</figure>
</div>
<p>Ce traitement n√©cessite :</p>
<ul>
<li><p>le chargement de davantage de colonnes en m√©moire vive ;</p></li>
<li><p>davantage de m√©moire d‚Äôex√©cution pour effectuer l‚Äôintersection (<code>inner_join()</code>).</p></li>
</ul>
</section>
</section>
<section id="initiation-au-calcul-distribu√©" class="level1">
<h1>Initiation au calcul distribu√©</h1>
<section id="calcul-distribu√©-et-calcul-parall√®le" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="calcul-distribu√©-et-calcul-parall√®le">Calcul distribu√© et calcul parall√®le</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="calcul-non-distribu√©" class="level3">
<h3 class="anchored" data-anchor-id="calcul-non-distribu√©">Calcul non distribu√©</h3>
<p>Les probl√©matiques Big Data en R sont les suivantes :</p>
<ul>
<li><p>la taille des donn√©es : charg√©es en m√©moire pour effectuer les calculs avec R</p></li>
<li><p>le temps de calcul : les √©tapes du traitement sont effectu√©es de mani√®re s√©quentielle par le processeur (tr√®s long)</p></li>
<li><p>l‚Äôoptimisation du programme</p></li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="calcul-distribu√©-spark" class="level3">
<h3 class="anchored" data-anchor-id="calcul-distribu√©-spark">Calcul distribu√© spark</h3>
<p>Le calcul distribu√© avec spark apporte une solution √† ces probl√©matiques :</p>
<ul>
<li><p>chargement des donn√©es en m√©moire parcimonieux et non syst√©matique</p></li>
<li><p>ex√©cution de t√¢ches en parall√®le sur plusieurs coeurs du processeur, voire sur plusieurs ordinateurs diff√©rents</p></li>
<li><p>optimisation automatique du code</p></li>
</ul>
</section>
</div>
</div>
</section>
<section id="un-traitement-map-distribu√©" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="un-traitement-map-distribu√©">Un traitement MAP distribu√©</h2>
<p><img src="map_distribue.drawio.png" class="img-fluid"></p>
<p>Si les donn√©es sont stock√©es sur diff√©rents ordinateurs :</p>
<ul>
<li><p>les calculs peuvent √™tre effectu√©s en parall√®le ;</p></li>
<li><p>gain de temps li√© √† l‚Äôaugmentation des ressources informatiques pour effectuer le calcul et √† la parall√©lisation.</p></li>
</ul>
<p>Les traitements MAP se pr√™tent parfaitement au calcul distribu√© et parall√®le.</p>
</section>
<section id="un-traitement-reduce-distribu√©" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="un-traitement-reduce-distribu√©">Un traitement REDUCE distribu√©</h2>
<p><img src="reduce_distribue.drawio.png" class="img-fluid"></p>
<p>Si les donn√©es sont stock√©es sur diff√©rents ordinateurs :</p>
<ul>
<li><p>il faut les rappatrier au m√™me endroit pour effectuer la jointure ;</p></li>
<li><p>cet √©change est effectu√© en r√©seau entre les ordinateurs : l‚Äôenvoi r√©seau a un co√ªt non n√©gligeable en temps.</p></li>
</ul>
<p>Les traitements REDUCE ne se pr√™tent pas bien au calcul distribu√© et parall√®le.</p>
</section>
<section id="spark" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="spark">Spark</h2>
<ul>
<li><p>Apache Spark : <strong>librairie open source</strong> d√©velopp√©e dans le langage <code>scala</code></p></li>
<li><p><strong>Scala</strong> : langage compil√©, rapide et distribuable qui peut √™tre ex√©cut√© dans une machine virtuelle Java</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>val TopHorrorsIGN2022 <span class="ot">=</span> <span class="fu">Seq</span>(</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="st">"Pearl"</span>),</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="st">"The Sadness"</span>),</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">6</span>, <span class="st">"Offseason"</span>),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="st">"Hatching"</span>),</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="st">"x"</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>)<span class="fu">.toDF</span>(<span class="st">"IMDB Rating"</span>, <span class="st">"IGN Movie Picks"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>val TopHorrorsTheAVClub2022 <span class="ot">=</span> <span class="fu">Seq</span>(</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">7</span>, <span class="st">"Nope"</span>),</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">9</span>, <span class="st">"Pearl"</span>),</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">8</span>, <span class="st">"x"</span>),</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="st">"Barbarian"</span>),</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  (<span class="dv">5</span>, <span class="st">"Bones And All"</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>)<span class="fu">.toDF</span>(<span class="st">"IMDB Rating"</span>, <span class="st">"AVC Movie Picks"</span>)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>import org.apache.spark.sql.functions.col</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>val cols <span class="ot">=</span> <span class="fu">List</span>(<span class="fu">col</span>(<span class="st">"IGN Movie Picks"</span>), <span class="fu">col</span>(<span class="st">"AVC Movie Picks"</span>))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>val query <span class="ot">=</span> <span class="fu">TopHorrorsIGN2022</span>(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"IGN Movie Picks"</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>) <span class="sc">==</span><span class="er">=</span> <span class="fu">TopHorrorsTheAVClub2022</span>(<span class="st">"AVC Movie Picks"</span>)</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>val outerJoin <span class="ot">=</span> TopHorrorsIGN2022</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.join</span>(TopHorrorsTheAVClub2022, query, <span class="st">"outer"</span>)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">.select</span>(cols<span class="sc">:</span> _<span class="sc">*</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="fu">outerJoin.show</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p><code>scala</code> adapt√© pour ma√Ætriser toutes les fonctionnalit√©s de <code>spark</code> et optimiser au maximum les traitements en <code>spark</code></p></li>
<li><p><code>spark</code> est <strong>compatible avec les langages</strong> <code>scala</code>, <code>R</code>, <code>python</code>, <code>java</code>, et peut interpr√©ter des commandes <strong>SQL.</strong></p></li>
<li><p>Deux packages existent sous R :</p>
<ul>
<li><p><strong>sparkR</strong> propos√© par Apache Spark</p></li>
<li><p><strong>sparklyr</strong>, qui permet d‚Äôutiliser directement des commandes dplyr traduites en spark par le package.</p></li>
</ul></li>
</ul>
</section>
<section id="installation-de-spark-sous-casd" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="installation-de-spark-sous-casd">Installation de spark sous CASD</h2>
<p>Voir la fiche d√©di√©e sur le site</p>
</section>
<section id="la-machine-virtuelle-java" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="la-machine-virtuelle-java">La machine virtuelle Java</h2>
<p>Spark est r√©dig√© en scala, un langage qui a besoin d‚Äôune machine virtuelle Java pour √™tre ex√©cut√©. La machine virtuelle Java est scalable : l‚Äôutilisateur peut choisir quelles ressources physiques elle a le droit d‚Äôutiliser sur l‚Äôensemble des ressources physiques disponibles sur l‚Äôordinateur. C‚Äôest un mini ordinateur cr√©√© par spark √† l‚Äôint√©rieur de notre propre ordinateur, qui utilise les ressources de ce dernier.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Machine virtuelle
</div>
</div>
<div class="callout-body-container callout-body">
<p>Une machine virtuelle a les m√™mes caract√©ristiques qu‚Äôun ordinateur :</p>
<ul>
<li><p>un syst√®me d‚Äôexploitation : Windows, Linux, MacOS</p></li>
<li><p>des ressources physiques : CPU, RAM et stockage disque</p></li>
</ul>
<p>La diff√©rence avec un ordinateur : une machine virtuelle peut √™tre cr√©√©e sur un serveur physique en r√©servant une petite partie des ressources du serveur seulement, ce qui permet de cr√©er plusieurs ordinateurs diff√©rents sur une seule infractructure physique</p>
</div>
</div>
</section>
<section id="deux-mani√®res-dutiliser-spark" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="deux-mani√®res-dutiliser-spark">Deux mani√®res d‚Äôutiliser Spark</h2>
<div class="columns">
<div class="column" style="width:50%;">
<section id="avec-un-seul-ordinateur" class="level3">
<h3 class="anchored" data-anchor-id="avec-un-seul-ordinateur">Avec un seul ordinateur</h3>
<p>Ce mode est appel√© Spark local.</p>
<ul>
<li><p>une unique machine virtuelle Java est cr√©√©e pour ex√©cuter le code spark</p></li>
<li><p>t√¢ches parall√©lis√©es sur les diff√©rents coeurs (CPU) du processeur de la machine virtuelle Java</p></li>
<li><p>l‚Äôordinateur sur lequel est cr√©√©e cette machine virtuelle Java est la bulle MiDARES, √©quivalent d‚Äôun unique gros ordinateur</p></li>
</ul>
</section>
</div><div class="column" style="width:50%;">
<section id="sur-un-cluster-de-calcul" class="level3">
<h3 class="anchored" data-anchor-id="sur-un-cluster-de-calcul">Sur un cluster de calcul</h3>
<p>Un cluster de calcul est un ensemble d‚Äôordinateurs ou machines virtuelles connect√©s en r√©seau.</p>
<ul>
<li><p>une machine virtuelle Java est cr√©√©e par spark dans chaque ordinateur du cluster</p></li>
<li><p>t√¢ches parall√©lis√©es sur les diff√©rents ordinateurs du cluster</p></li>
<li><p>la session R reste sur la bulle MiDARES, le code R est traduit en scala puis envoy√© sur le cluster pour √™tre ex√©cut√©.</p></li>
</ul>
</section>
</div>
</div>
</section>
<section id="mode-local-sch√©ma" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="mode-local-sch√©ma">Mode local : sch√©ma</h2>
<p><img src="mode_local.PNG" class="img-fluid"></p>
</section>
<section id="mode-local-√†-√©viter" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="mode-local-√†-√©viter">Mode local : √† √©viter</h2>
<p>En mode local :</p>
<ul>
<li><p>les ressources utilis√©es par la machine virtuelle sont celles de la bulle</p></li>
<li><p>il faut allouer suffisamment de coeurs √† la JVM pour parall√©liser</p></li>
<li><p>m√™me si l‚Äôutilisateur choisit des ressources faibles, les ressources r√©elles utilis√©es dans une session spark peuvent √™tre plus √©lev√©es : mauvaise gestion de l‚Äôallocation des ressources</p></li>
<li><p>acc√©l√©ration sensible par rapport √† un mode de programmation classique s√©quentiel sur un unique coeur si beaucoup de ressources</p></li>
<li><p>Sur la bulle CASD, mauvaise gestion de la r√©partition des ressources en spark local : l‚Äôutilisation simultan√©e de spark par plusieurs membres de la bulle entra√Ænent des ralentissements consid√©rables</p>
<p>‚ñ∂Ô∏èmode local √† √©viter absolument</p></li>
</ul>
</section>
<section id="le-cluster-de-calcul-midares-pr√©sentation" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-cluster-de-calcul-midares-pr√©sentation">Le cluster de calcul Midares : pr√©sentation</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="691"></p>
</figure>
</div>
</section>
<section id="se-connecter-√†-spark-sur-un-cluster" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="se-connecter-√†-spark-sur-un-cluster">Se connecter √† Spark sur un cluster</h2>
<p>Se connecter √† spark revient √† demander √† spark de cr√©er toutes les JVM demand√©es capables de lire du scala.</p>
<p>Pour se connecter √† spark depuis R avec le package <code>sparklyr</code> :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">library</span>(sparklyr)</span>
<span id="cb2-2"><a href="#cb2-2"></a></span>
<span id="cb2-3"><a href="#cb2-3"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb2-4"><a href="#cb2-4"></a>conf<span class="sc">$</span>spark.executor.instances <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Le param√®tre <code>spark.executor.instances</code> correspond au nombre d‚Äôordinateurs sur lequel on souhaite parall√©liser le travail d‚Äôex√©cution de code. Ici, l‚Äôutilisateur demande 5 ordinateurs du cluster.</p>
<p>Nous verrons plus loin quels param√®tres nous devons pr√©ciser dans le fichier de configuration.</p>
</section>
<section id="une-connexion" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="une-connexion">Une connexion</h2>
<p>Toutes les JVM demand√©es (5) sont instanci√©es dans les ordinateurs du cluster, avec les param√®tres d√©finis.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="691"></p>
</figure>
</div>
</section>
<section id="la-vie-dun-programme-r√©dig√©-en-sparklyr" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="la-vie-dun-programme-r√©dig√©-en-sparklyr">La vie d‚Äôun programme r√©dig√© en sparklyr</h2>
<p>Avec <code>sparklyr</code>, il est possible de programmer directement en <code>dplyr</code> pour utiliser spark.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># un data frame que j'envoie dans spark</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>un_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="fu">c</span>(<span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>))</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(un_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"col_num"</span>, <span class="st">"col_char"</span>)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># C'est maintenant un spark_data_frame</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">copy_to</span>(sc, un_df)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>un_df_transforme <span class="ot">&lt;-</span> un_df <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">une_nouvelle_col =</span> col_num<span class="sc">*</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Si j‚Äôex√©cute ce programme, je ne pourrai pas ouvrir <code>un_df_transforme</code>, d‚Äôailleurs, il ne se sera rien pass√©.</p>
</section>
<section id="la-lazy-evaluation" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="la-lazy-evaluation">La lazy evaluation</h2>
<p>Spark distingue deux types d‚Äôop√©rations :</p>
<ul>
<li><p><strong>les transformations :</strong> ce sont des op√©rations qui prennent en entr√©e un <code>spark_data_frame</code> et retournent un <code>spark_data_frame</code>, elles ne d√©clenchent aucun calcul lorsqu‚Äôelles sont appel√©es.</p>
<p>Par exemple, le programme ci-dessous est compil√© instantan√©ment et ne d√©clenche pas d‚Äôex√©cution :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>une_transformation <span class="ot">&lt;-</span> un_spark_data_frame <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(identifiant) <span class="sc">%&gt;%</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">une_somme =</span> <span class="fu">sum</span>(revenus))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p><strong>les actions :</strong> ce sont des op√©rations qui demandent le calcul d‚Äôun r√©sultat et qui d√©clenchent le calcul et l‚Äôex√©cution de toutes les transformations compil√©es jusqu‚Äô√† l‚Äôappel de l‚Äôaction.</p>
<p>Par exemple, le programme ci-dessous d√©clenche le calcul de la cellule <code>une_transformation</code> et de la moyenne des revenus :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>revenu_moyen <span class="ot">&lt;-</span> une_transformation <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">revenu_moyen =</span> <span class="fu">mean</span>(une_somme)) <span class="sc">%&gt;%</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Les principales actions sont : <code>print()</code>, <code>collect()</code>, <code>head()</code>, <code>tbl_cache()</code> (√©crire un <code>spark_data_frame</code> en m√©moire pour le r√©utiliser).</p></li>
</ul>
</section>
<section id="la-vie-dun-programme-r√©dig√©-en-sparklyr-1" class="level2">
<h2 class="anchored" data-anchor-id="la-vie-dun-programme-r√©dig√©-en-sparklyr-1">La vie d‚Äôun programme r√©dig√© en sparklyr</h2>
<p>Prenons l‚Äôexemple d‚Äôun programme contenant une action.</p>
<div class="cell">

</div>
</section>
<section id="le-r√¥le-du-driver" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-r√¥le-du-driver">Le r√¥le du driver</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="400"></p>
</figure>
</div>
<ul>
<li><p>Le programme R est traduit en scala gr√¢ce au package <code>sparklyr</code></p></li>
<li><p>Le driver √©value le programme, il lit le code <code>scala</code> mais n‚Äôex√©cute rien du tout</p></li>
<li><p>S‚Äôil remarque une erreur, l‚Äôerreur est envoy√©e directement √† l‚Äôutilisateur en session R avant l‚Äôex√©cution du programme : c‚Äôest la force de la lazy evaluation.</p></li>
</ul>
</section>
<section id="le-plan-dex√©cution" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-plan-dex√©cution">Le plan d‚Äôex√©cution</h2>
<p><img src="catalyst.jpg" class="img-fluid"></p>
<p>source : documentation CASD disponible √† <a href="https://casd-eu.gitbook.io/data-science/">Documentation Data Science</a></p>
<p>AJOUTER UN DAG</p>
</section>
<section id="le-r√¥le-du-driver-catalyst" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="le-r√¥le-du-driver-catalyst">Le r√¥le du driver : Catalyst</h2>
<p>Le driver contient un programme nomm√© Catalyst qui optimise le code <code>scala</code> automatiquement.</p>
<p>Spark optimise automatiquement les programmes soumis :</p>
<ol type="1">
<li><p>Compilation des transformations pour soulever les √©ventuelles erreurs</p></li>
<li><p>Int√©gration dans un <strong>plan d‚Äôex√©cution</strong> contenant les √©tapes n√©cessaires pour parvenir au r√©sultat demand√© par le programme</p></li>
<li><p>Optimisation du plan logique par le module <strong>Catalyst</strong> (driver Spark)</p></li>
</ol>
<p>Par exemple si j‚Äô√©cris le programme :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>non_optimal <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span>   </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">duree_contrat =</span> <span class="fu">DATEDIFF</span>(fin_contrat, debut_contrat)) <span class="sc">%&gt;%</span>   </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(debut_contrat <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<pre><code>Catalyst r√©√©crit :</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>optimal <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span>   </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(debut_contrat <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2023-01-01"</span>)) <span class="sc">%&gt;%</span>   </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">duree_contrat =</span> <span class="fu">DATEDIFF</span>(fin_contrat, debut_contrat))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Cette optimisation est r√©alis√©e sur toutes les transformations compil√©e avant qu‚Äôune action d√©clenche l‚Äôex√©cution.</p>
</section>
<section id="le-r√¥le-du-driver-catalyst-1" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="le-r√¥le-du-driver-catalyst-1">Le r√¥le du driver : Catalyst</h2>
<p><img src="dag.webp" class="img-fluid"></p>
</section>
<section id="le-r√¥le-du-driver-catalyst-2" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="le-r√¥le-du-driver-catalyst-2">Le r√¥le du driver : Catalyst</h2>
<ol start="4" type="1">
<li><p>R√©alisation de plans physiques possibles et s√©lection du <strong>meilleur plan physique</strong> (au regard de la localisation des donn√©es requises). Le plan physique est la distribution des diff√©rents calculs aux machines du cluster.</p></li>
<li><p><strong>D√©clencher le moins d‚Äôactions possibles</strong> dans son programme permet de tirer pleinement parti de Catalyst et de gagner un temps certain.</p></li>
<li><p>Pour profiter des avantages de spark, la mani√®re de programmer recommand√©e est diff√©rente de celle pr√©dominante en R classique.</p></li>
</ol>
</section>
<section id="le-r√¥le-du-cluster-manager" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-r√¥le-du-cluster-manager">Le r√¥le du cluster manager</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="400"></p>
</figure>
</div>
<p>Le cluster manager distribue les traitements physiques aux ordinateurs du cluster :</p>
<ul>
<li><p>il conna√Æt le meilleur plan physique fourni par Catalyst ;</p></li>
<li><p>il conna√Æt les ressources disponibles et occup√©es par toutes les machines du cluster ;</p></li>
<li><p>il affecte les ressources disponibles √† la session spark.</p></li>
</ul>
</section>
<section id="le-r√¥le-du-worker" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="le-r√¥le-du-worker">Le r√¥le du worker</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="400"></p>
</figure>
</div>
<p>Le worker effectue le morceau de programme qu‚Äôon lui affecte et renvoie le r√©sultat au driver, qui lui-m√™me affiche le r√©sultat en session R :</p>
<ul>
<li><p>il ne conna√Æt que les t√¢ches qu‚Äôon lui a affect√©es ;</p></li>
<li><p>il peut communiquer avec le driver en r√©seau pour renvoyer un r√©sultat ;</p></li>
<li><p>il peut communiquer avec les autres workers en r√©seau pour partager des donn√©es ou des r√©sultats interm√©diaires : c‚Äôest un shuffle.</p></li>
</ul>
</section>
<section id="o√π-sont-les-donn√©es" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="o√π-sont-les-donn√©es">O√π sont les donn√©es ?</h2>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="schema_cluster.drawio.png" class="img-fluid figure-img" width="400"></p>
</figure>
</div>
</section>
<section id="o√π-sont-les-donn√©es-1" class="level2">
<h2 class="anchored" data-anchor-id="o√π-sont-les-donn√©es-1">O√π sont les donn√©es ?</h2>
<p><img src="hdfs_browse.png" class="img-fluid"></p>
</section>
<section id="transfert-de-la-bulle-√†-hdfs" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="transfert-de-la-bulle-√†-hdfs">Transfert de la bulle √† HDFS</h2>
<p><img src="hdfs_dowload.PNG" class="img-fluid"></p>
</section>
<section id="transfert-de-hdfs-√†-la-bulle" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="transfert-de-hdfs-√†-la-bulle">Transfert de HDFS √† la bulle</h2>
<p><img src="hdfs_midas.PNG" class="img-fluid"></p>
</section>
<section id="mais-o√π-sont-r√©ellement-les-donn√©es-hdfs" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="mais-o√π-sont-r√©ellement-les-donn√©es-hdfs">Mais o√π sont r√©ellement les donn√©es ? HDFS</h2>
<p>Hadoop Distributed File System (HDFS)</p>
<ul>
<li><p><strong>stockage sur diff√©rentes machines :</strong> ici les noeuds du cluster spark, c‚Äôest-√†-dire les diff√©rents ordinateurs workers du cluster</p></li>
<li><p>donn√©es divis√©es <strong>en blocs</strong> plus petits de taille fixe et r√©partis sur les machines : aucune table de MiDAS n‚Äôexiste en entier sur le cluster</p></li>
<li><p>chaque bloc est <strong>r√©pliqu√© trois fois</strong> : il existe trois fois les 10 premi√®res lignes de la table FNA sur trois ordinateurs diff√©rents du cluster (r√©silience)</p></li>
<li><p>un <strong>NameNode</strong> supervise les <strong>m√©tadonn√©es</strong> et g√®re la structure du syst√®me de fichiers</p></li>
<li><p>les <strong>DataNodes</strong> stockent effectivement les blocs de donn√©es : les datanodes sont en fait les disques des workers du cluster, chaque ordinateur du cluster dispose d‚Äôun disque avec une partie des donn√©es MiDAS</p></li>
<li><p>le <strong>syst√®me HDFS</strong> est reli√© √† la bulle Midares : possible de charger des donn√©es en clique-bouton de la bulle vers HDFS de mani√®re tr√®s rapide et de t√©l√©charger des tables de HDFS pour les r√©cup√©rer en local</p></li>
</ul>
</section>
</section>
<section id="programmer-avec-sparklyr" class="level1">
<h1>Programmer avec sparklyr</h1>
<section id="param√©trer-sa-session" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="param√©trer-sa-session">Param√©trer sa session</h2>
<p>Il faut pr√©ciser quelles ressources r√©server pour chaque unit√© spark : le driver, le nombre d‚Äôordinateurs workers (appel√©es instances), la RAM, le nombre de coeurs</p>
<p>La configuration par d√©faut est :</p>
<p>Il est n√©cessaire de configurer la session spark pour √©tablir une connexion entre la session R et un cluster spark. Les param√®tres √† d√©finir sont :</p>
<ul>
<li><p>Les ressources physiques utilis√©es :</p>
<ol type="1">
<li><p>par le <strong>driver</strong> : avec <code>spark.driver.memory</code> <strong>(avec parcimonie)</strong></p></li>
<li><p>par chaque <strong>worker</strong> avec <code>spark.executor.memory</code>(valeur max <strong>140 Go</strong>) et <code>spark.executor.cores</code> (valeur max <strong>8 coeurs</strong>)</p></li>
<li><p>le nombre de <strong>workers</strong> avec <code>spark.executor.instances</code> <strong>(2 ou 3 suffisent)</strong></p></li>
<li><p>La <strong>file</strong> sur laquelle on travaille avec <code>spark.yarn.queue</code> <strong>(prod ou dev)</strong></p></li>
</ol></li>
<li><p>le nombre de <strong>partitions</strong> de chaque <code>spark_data_frame</code> avec <code>spark.sql.shuffle.partitions</code> <strong>(200 par d√©faut)</strong></p></li>
<li><p>la <strong>limite de taille des r√©sulats</strong> qui peuvent √™tre <strong>collect√©s</strong> par le driver avec <code>spark.driver.maxResultSize</code> <strong>(0 est la meilleure option)</strong></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"60Go"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mode-cluster-non-concurrence-gr√¢ce-au-cluster-manager" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="mode-cluster-non-concurrence-gr√¢ce-au-cluster-manager">Mode cluster : non concurrence gr√¢ce au cluster manager</h2>
<p><img src="mode_cluster.PNG" class="img-fluid"></p>
<p>Le mode cluster permet une r√©elle distribution sur diff√©rents noeuds, qui sont en fait des ordinateurs distincts d‚Äôun serveur. Ces machines communiquent en r√©seau.</p>
<p>Capture d‚Äô√©cran r√©servation des ressources</p>
<p>Il est donc n√©cessaire de se d√©connecter pour lib√©rer les ressources : des ressources r√©serv√©es, m√™me lorsqu‚Äôaucun programme ne tourne, ne peuvent jamais √™tre affect√©es √† d‚Äôautres utilisateurs.</p>
<div class="cell">

</div>
</section>
<section id="importer-les-donn√©es-depuis-hdfs-sous-r" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="importer-les-donn√©es-depuis-hdfs-sous-r">Importer les donn√©es depuis HDFS sous R</h2>
<p>Les donn√©es doivent √™tre disponibles dans les workers sous forme de <code>spark_data_frame</code> :</p>
<ul>
<li><p><strong>cach√© en m√©moire directement</strong> : si utilis√©es de tr√®s nombreuses fois pour gagner du temps</p></li>
<li><p>laiss√© sur disque tant qu‚Äôaucune action ne d√©clenche un traitement qui n√©cessite son chargement en m√©moire</p>
<p>‚ñ∂Ô∏è chargement en m√©moire vive couteux en temps : avec la configuration pr√©sent√©e, le chargement du FNA, du FHS et des MMO prend au moins 25 minutes.</p></li>
<li><p>Pour passer un <code>data.frame</code> R en spark_data_frame : <code>copy_to()</code></p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>pjc_df_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/FNA/pjc.parquet"</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">memory =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>pjc_filtree <span class="ot">&lt;-</span> pjc_df_spark <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(KDDPJ <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2022-01-01"</span>))</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="fu">spark_write_parquet</span>(pjc_filtree, <span class="st">"hdfs:///tmp/pjc_filtree.parquet"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>pjc_df_spark <span class="ot">&lt;-</span> <span class="fu">copy_to</span>(sc, <span class="st">"PJC"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="les-exports-sur-hdfs" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="les-exports-sur-hdfs">Les exports sur HDFS</h2>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Les exports sur HDFS
</div>
</div>
<div class="callout-body-container callout-body">
<p>Lorsqu‚Äôon exporte une table depuis notre session R vers HDFS, celle-ci est <strong>automatiquement partitionn√©e</strong>, comme le reste des donn√©es.</p>
<p>Ainsi, cette table sera stock√©e en plusieurs morceaux sous HDFS et r√©pliqu√©e.</p>
<p>Il est possible de ma√Ætriser le nombre de partitions avec la commande <code>sdf_coalesce(partitions = 5)</code> du package <code>sparklyr</code>.</p>
<p>L‚Äôid√©al est d‚Äô<strong>adapter le nombre de partitions √† la taille d‚Äôun bloc</strong> : un bloc mesure 128 MB. Lorsqu‚Äôun bloc disque est utilis√©, m√™me √† 1%, il n‚Äôest pas utilisable pour un autre stockage.</p>
<p>Exporter un fichier de 1MB en 200 partitions r√©serve 200 blocs inutilement.</p>
</div>
</div>
</section>
<section id="les-shuffles" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="les-shuffles">Les shuffles</h2>
<p><img src="reduce_distribue.drawio.png" class="img-fluid"></p>
<p>Comme nous l‚Äôavons vu, les traitements REDUCE ne se pr√™tent pas tr√®s bien au calcul distribu√© :</p>
<ul>
<li><p>augmenter le nombre de workers augmente la probabilit√© de devoir effectuer des shuffles</p></li>
<li><p>il est recommand√© de se limiter √† deux workers comme dans la configuration propos√©e</p></li>
<li><p>r√©server d‚Äôautres ressources n‚Äôest souvent pas efficient et monopolise les ressources pour les autres utilisateurs.</p></li>
</ul>
</section>
<section id="r√©cup√©rer-un-r√©sultat" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="r√©cup√©rer-un-r√©sultat">R√©cup√©rer un r√©sultat</h2>
<p>Les r√©sultats qu‚Äôil est recommand√© de r√©cup√©rer en m√©moire vive en session R sont de la forme suivante :</p>
<ul>
<li><p><strong>une table filtr√©e</strong> avec les variables n√©cessaires √† l‚Äô√©tude uniquement : sous MiDAS, toutes les jointures, les calculs de variable et les filtres peuvent √™tre effectu√©s de mani√®re efficiente sous la forme de spark_data_frame, sans jamais collecter les donn√©es MiDAS ;</p></li>
<li><p>des <strong>statistiques descriptives synth√©tiques ;</strong></p></li>
<li><p>les <strong>premi√®res lignes</strong> de la table pour v√©rifier que le programme retourne bien le r√©sultat attendu ;</p></li>
<li><p>une <strong>table agr√©g√©e</strong> pour un graphique par exemple, √† l‚Äôaide de la fonction <code>summarise()</code>.</p></li>
</ul>
</section>
<section id="lutilisation-de-la-m√©moire-du-driver" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="lutilisation-de-la-m√©moire-du-driver">L‚Äôutilisation de la m√©moire du driver</h2>
<p><img src="collect.drawio.png" class="img-fluid"></p>
</section>
<section id="lutilisation-de-la-m√©moire-du-driver-1" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="lutilisation-de-la-m√©moire-du-driver-1">L‚Äôutilisation de la m√©moire du driver</h2>
<p>Lorsqu‚Äôil est n√©cessaire de collecter une table volumineuse, il faut donc pr√©voir assez de m√©moire RAM pour le driver.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb11-2"><a href="#cb11-2"></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-caution callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Bonne pratique de partage des ressources
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le driver est instanci√© dans la bulle Midares, qui a vocation √† √™tre r√©duite suite √† la g√©n√©ralisation du cluster.</p>
<ul>
<li><p>La bulle Midares a besoin de RAM minimale pour fonctionner, 100% des ressources ne sont donc pas disponibles pour <code>sparklyr</code>.</p></li>
<li><p>Pour permettre le <strong>travail simultan√© fluide de 10 utilisateurs</strong>, la m√©moire allou√©e au driver recommand√©e pour chaque utilisateur est de <strong>15 Go</strong>.</p></li>
<li><p><strong>L‚Äôexport d‚Äôune table</strong> <code>sdf</code> directement au format <code>.parquet</code> est une alternative plus rapide, plus efficiente et qui permet par la suite de charger ses donn√©es en R classique et de travailler sur un <code>df</code> R sans utiliser <code>sparklyr</code>.</p></li>
</ul>
</div>
</div>
</section>
<section id="comment-tester-son-code-pour-collecter-le-moins-possible" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="comment-tester-son-code-pour-collecter-le-moins-possible">Comment tester son code pour collecter le moins possible ?</h2>
<p>La programmation en spark doit √™tre adapt√©e aux contraintes de volum√©trie des donn√©es : test de chaque √©tape, puis ne forcer le calcul qu‚Äô√† la fin pour que Catalyst optimise l‚Äôensemble du programme</p>
<p>La principale diff√©rence avec la programmation en R classique est que <strong>la visualisation de tables compl√®tes volumineuses n‚Äôest pas recommand√©e</strong> :</p>
<ul>
<li><p><strong>goulets d‚Äô√©tranglement</strong> m√™me avec spark, car toutes les donn√©es sont rapatri√©es vers le driver puis vers la session R ;</p></li>
<li><p><strong>longue :</strong> √©change entre tous les noeuds impliqu√©s dans le calcul et le driver, puis un √©change driver-session R ;</p></li>
<li><p><strong>beaucoup moins efficace que l‚Äôexport direct en parquet</strong> du r√©sultat (presque instantann√©) : charger ensuite sa table finale en data frame R classique pour effectuer l‚Äô√©tude.</p></li>
</ul>
<p>S‚Äôil est n√©cessaire de collecter, il faut pr√©voir <strong>beaucoup de RAM pour le driver avec le param√®tre</strong> <code>spark.driver.memory</code><strong>.</strong></p>
</section>
</section>
<section id="sparklyr-la-solution-ergonomique-de-spark-sous-r" class="level1">
<h1>Sparklyr : la solution ergonomique de spark sous R</h1>
<section id="ce-qui-change-pour-lutilisateur" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="ce-qui-change-pour-lutilisateur">Ce qui change pour l‚Äôutilisateur</h2>
<p>La majorit√© des commandes <code>dplyr</code> fonctionnent sur un spark_data_frame avec le package <code>sparklyr</code>. Les divergences principales sont les suivantes :</p>
<table class="table">
<colgroup>
<col style="width: 37%">
<col style="width: 23%">
<col style="width: 38%">
</colgroup>
<thead>
<tr class="header">
<th>Fonctionnalit√©</th>
<th>tidyverse</th>
<th>sparklyr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>import d‚Äôun fichier <code>.parquet</code></td>
<td><code>read_parquet</code></td>
<td><code>spark_read_parquet()</code></td>
</tr>
<tr class="even">
<td>tri d‚Äôun tableau</td>
<td><code>arrange()</code></td>
<td><code>window_order()</code> ou <code>sdf_sort()</code></td>
</tr>
<tr class="odd">
<td>op√©rations sur les dates</td>
<td><code>lubridate</code></td>
<td>fonctions Hive</td>
</tr>
<tr class="even">
<td>empiler des tableaux</td>
<td><code>bind_rows()</code></td>
<td><code>sdf_bind_rows()</code></td>
</tr>
<tr class="odd">
<td>nombre de lignes d‚Äôun tableau</td>
<td><code>nrow()</code></td>
<td><code>sdf_nrow()</code></td>
</tr>
<tr class="even">
<td>faire pivoter un tableau</td>
<td><code>tidyr</code></td>
<td><code>sdf_pivot()</code></td>
</tr>
<tr class="odd">
<td>export d‚Äôun <code>spark_data_frame</code></td>
<td></td>
<td><code>spark_write_parquet()</code></td>
</tr>
</tbody>
</table>
</section>
<section id="quelques-fonctions-sp√©cifiques" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="quelques-fonctions-sp√©cifiques">Quelques fonctions sp√©cifiques</h2>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Dates</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Tableau</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Statistiques</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<p>Les fonctions de <code>lubridate()</code>ne sont pas adapt√©es au <code>spark_data_frames</code>.</p>
<ul>
<li><p>Convertir une cha√Æne de caract√®re de la forme AAAA-MM-DD en Date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>date_1 <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2024-05-26"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Calculer une dur√©e entre deux dates</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>PJC_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/pjc.parquet"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">memory =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>duree_pjc_df <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">date_fin_pjc =</span> <span class="fu">as.Date</span>(KDFPJ),</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_deb_pjc =</span> <span class="fu">as.Date</span>(KDDPJ)) <span class="sc">%&gt;%</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duree_pjc =</span> <span class="fu">datediff</span>(date_fin_pjc, date_deb_pjc) <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Ajouter ou soustraire des jours ou des mois √† une date</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>duree_pjc_bis_df <span class="ot">&lt;-</span> duree_pjc_df <span class="sc">%&gt;%</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">duree_pjc_plus_5 =</span> <span class="fu">date_add</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">5</span>)),</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">duree_pjc_moins_5 =</span> <span class="fu">date_sub</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">5</span>)),</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">duree_pjc_plus_1_mois =</span> <span class="fu">add_months</span>(duree_pjc, <span class="fu">int</span>(<span class="dv">1</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Add_months
</div>
</div>
<div class="callout-body-container callout-body">
<p>Si la date en entr√©e est le dernier jour d‚Äôun mois, la date retourn√©e avec <code>add_months(date_entree, int(1))</code> sera le dernier jour calendaire du mois suivant.</p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Format
</div>
</div>
<div class="callout-body-container callout-body">
<p>Le <code>int()</code> est important car ces fonctions Hive n‚Äôaccepte que les entiers pour l‚Äôajout de jours : taper uniquement 5 est consid√©r√© comme un flottant dans R.</p>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<ul>
<li><p>Tri dans un groupe pour effectuer un calcul s√©quentiel</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>ODD_spark <span class="ot">&lt;-</span> <span class="fu">spark_read_parquet</span>(sc,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                                <span class="at">path =</span> <span class="st">"hdfs:///dataset/MiDAS_v4/odd.parquet"</span>,</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>                                <span class="at">memory =</span> <span class="cn">FALSE</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>ODD_premier <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(id_midas) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">window_order</span>(id_midas, KDPOD) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date_premier_droit =</span> <span class="fu">first</span>(KDPOD)) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(id_midas, KROD3, date_premier_droit) <span class="sc">%&gt;%</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Tri pour une sortie : <code>sdf_sort()</code> , <code>arrange()</code> ne fonctionne pas</p></li>
<li><p>Concat√©ner les lignes (ou les colonnes <code>sdf_bind_cols()</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ODD_1 <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(KDPOD <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2017-12-31"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="st">"temoins"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>ODD_2 <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(KDPOD <span class="sc">&gt;=</span> <span class="fu">as.Date</span>(<span class="st">"2021-12-31"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="st">"traites"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>ODD_evaluation <span class="ot">&lt;-</span> <span class="fu">sdf_bind_rows</span>(ODD_1, ODD_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>D√©doublonner une table</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>droits_dans_PJC <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdf_distinct</span>(id_midas, KROD3)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(droits_dans_PJC, <span class="dv">5</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>PJC_dedoublonnee <span class="ot">&lt;-</span> PJC_spark <span class="sc">%&gt;%</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdf_drop_duplicates</span>()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(PJC_dedoublonnee, <span class="dv">5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Pivot : les fonctions du packag <code>tidyr</code> ne fonctionnent pas sur donn√©es spark</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>ODD_sjr_moyen <span class="ot">&lt;-</span> ODD_spark <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">groupe =</span> <span class="fu">ifelse</span>(KDPOD <span class="sc">&lt;=</span> <span class="fu">as.Date</span>(<span class="st">"2020-12-31"</span>), <span class="st">"controles"</span>, <span class="st">"traites"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdf_pivot</span>(groupe <span class="sc">~</span> KCRGC,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun.aggregate =</span> <span class="fu">list</span>(<span class="at">KQCSJP =</span> <span class="st">"mean"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<ul>
<li><p>R√©sum√© statistique : <code>sdf_describe()</code> , <code>summary()</code>ne fonctionne pas.</p></li>
<li><p>Dimension : <code>sdf_dim</code>, la fonction <code>nrow()</code>ne fonctionne pas.</p></li>
<li><p>Quantiles approximatifs : le calcul des quantiles sur donn√©es distirbu√©es renvoie une approximation car toutes les donn√©es ne peuvent pas √™tre rappatri√©es sur la m√™me machine physique du fait de la volum√©trie, <code>sdf_quantile()</code></p></li>
<li><p>Echantillonnage al√©atoire : <code>sdf_random_split</code></p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="quelques-tips-doptimisation" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="quelques-tips-doptimisation">Quelques tips d‚Äôoptimisation</h2>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Jointures</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Persist</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Chargement</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false">Export et partitions</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<p>Pour effectuer ce type de jointure avec deux tables de volum√©tries diff√©rentes : A est petite, B est tr√®s volumineuse</p>
<p><img src="join.png" class="img-fluid"></p>
<p>Solution rapide :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>table_finale <span class="ot">&lt;-</span> table_volumineuse_comme_PJC <span class="sc">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">right_join</span>(petite_table_mon_champ)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Solution lente :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>table_finale <span class="ot">&lt;-</span> petite_table_mon_champ <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(table_volumineuse_comme_PJC)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<p>Lorsqu‚Äôune table interm√©diaire est utilis√©e plusieurs fois dans un traitement, il est possible de la persister, c‚Äôest-√†-dire enregistrer ce <code>spark_data_frame</code>sur le disque ou dans la m√©moire des noeuds.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>table_1 <span class="ot">&lt;-</span> mon_champ <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(ODD, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"id_midas"</span>, <span class="st">"KROD3"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">duree_potentielle_indemnisation =</span> KPJDXP,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">SJR =</span> KQCSJP,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">date_debut_indemnisation =</span> KDPOD) <span class="sc">%&gt;%</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdf_persist</span>()</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>duree <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">duree_moy =</span> <span class="fu">mean</span>(duree_potentielle_indemnisation),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            <span class="at">duree_med =</span> <span class="fu">median</span>(duree_potentielle_indemnisation)) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>SJR <span class="ot">&lt;-</span> table_1 <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">SJR_moy =</span> <span class="fu">mean</span>(SJR),</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">SJR_med =</span> <span class="fu">median</span>(SJR)) <span class="sc">%&gt;%</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<p>Lorsqu‚Äôon charge des donn√©es dans le cluster Spark et que la table est appel√©e plusieurs fois dans le programme, il est conseill√© de la charger en m√©moire vive directement.</p>
<p>Attention, si beaucoup de tables volumineuses sont charg√©es en m√©moire, la fraction de la m√©moire spark d√©di√©e au stockage peut √™tre insuffisante ou bien il peut ne pas rester assez de spark memory pour l‚Äôex√©cution.</p>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<p>Le format <code>.parquet</code> (avec <code>arrow</code>) et le framework <code>spark</code> permettent de g√©rer le partitionnement des donn√©es.</p>
<p>Si les op√©rations sont souvent effectu√©es par r√©gions par exemple, il est utile de forcer le stockage des donn√©es d‚Äôune m√™me r√©gion au m√™me endroit physique et acc√©l√®re drastiquement le temps de calcul</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spark_write_parquet</span>(DE, <span class="at">partition_by =</span> <span class="fu">c</span>(<span class="st">"REGIND"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-warning callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Exports simultan√©s
</div>
</div>
<div class="callout-body-container callout-body">
<p>HDFS supporte les exports simultan√©s, mais le temp d‚Äôexport est plus long lorsque le NameNode est requ√™t√© par plusieurs personnes simultan√©ment : d‚Äôapr√®s les tests cluster</p>
<ul>
<li><p>pour un petit export (5 minutes), le temps peut √™tre multipli√© par 4 ;</p></li>
<li><p>pour un gros export (15 minutes), le temps peut √™tre multipli√© par 2.</p></li>
</ul>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="forcer-le-calcul" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="forcer-le-calcul">Forcer le calcul</h2>
<p>Quelques actions :</p>
<ul>
<li><p>collecter la table enti√®re üõë</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">collect</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>afficher les premi√®res lignes</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
<li><p>Mettre les donner en cache</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>spark_data_frame_1 <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sdf_register</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tbl_cache</span>()</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>sc <span class="sc">%&gt;%</span> <span class="fu">spark_session</span>() <span class="sc">%&gt;%</span> <span class="fu">invoke</span>(<span class="st">"catalog"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">invoke</span>(<span class="st">"clearCache"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></li>
</ul>
</section>
<section id="les-erreurs-en-sparklyr" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="les-erreurs-en-sparklyr">Les erreurs en sparklyr</h2>
<p><code>sparklyr</code> traduit le code <code>dplyr</code> fourni en <code>scala</code>, mais interpr√®te √©galement les messages d‚Äôerreurs envoy√©s du cluster vers la session R.</p>
<p><code>sparklyr</code> n‚Äôest cependant pas performant pour interpr√©ter ces erreurs.</p>
<p>N‚Äôh√©sitez pas √† enregistrer le code g√©n√©rant un message d‚Äôerreur dans Documents publics/erreurs_sparklyr</p>
<p>Un test du code pas-√†-pas permet d‚Äôisoler le probl√®me.</p>
</section>
<section id="bonnes-pratiques" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="bonnes-pratiques">Bonnes pratiques</h2>
<ul>
<li><p>D√©connexion ou fermeture R pour lib√©rer les ressources üõë</p></li>
<li><p>Ne plus utiliser spark en local üñ•Ô∏èüñ•Ô∏èüñ•Ô∏è</p></li>
<li><p>Pyspark ou Sparklyr pour la production ‚ùì</p></li>
<li><p>Utilisation parcimonieuse des ressources ‚öñÔ∏è</p></li>
<li><p>Envoi des erreurs sparklyr üì©</p></li>
</ul>
</section>
</section>
<section id="pour-aller-plus-loin" class="level1">
<h1>Pour aller plus loin</h1>
<section id="larchitecture-map-reduce" class="level2">
<h2 class="anchored" data-anchor-id="larchitecture-map-reduce">L‚Äôarchitecture Map Reduce</h2>
<p><img src="map_reduce.png" class="img-fluid"></p>
</section>
<section id="la-gestion-de-la-m√©moire-avec-spark" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="la-gestion-de-la-m√©moire-avec-spark">La gestion de la m√©moire avec spark</h2>
<p>Les <strong>shuffles</strong> sont les op√©rations les plus gourmandes en temps.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Qu‚Äôest-ce qu‚Äôun shuffle ?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Un shuffle est un <strong>√©change de donn√©es entre diff√©rents noeuds</strong> du cluster.</p>
<p>Nous avons vu qu‚Äôutiliser <code>spark</code> dans un cluster implique de distribuer √©galement le stockage des donn√©es.</p>
<p>Par exemple :</p>
<ol type="1">
<li><p>je demande un traitement sur la table PJC du FNA</p></li>
<li><p>si un noeud contenant d√©j√† les donn√©es de PJC est disponible, le cluster manager envoie le traitement √† ce noeud</p></li>
<li><p>si tous les noeuds contenant les donn√©es de PJC sont d√©j√† r√©serv√©s, alors le cluster manager demande le traitement √† un autre noeud, par exemple le noeud 1</p></li>
<li><p>il demande √† un noeud contenant les donn√©es PJC, par exemple le noeud 4, d‚Äôenvoyer ces donn√©es au noeud 1 qui va ex√©cuter le traitement</p></li>
<li><p>cet √©change de donn√©es est en r√©seau filaire : un √©change filaire est beaucoup plus lent qu‚Äôun envoi interne par le disque du noeud 1 √† la RAM du noeud 1</p></li>
<li><p>c‚Äôest pourquoi pour optimiser un programme spark, il est possible de limiter les shuffles</p></li>
</ol>
</div>
</div>
</section>
<section id="lutilisation-de-la-m√©moire-dans-un-worker" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="lutilisation-de-la-m√©moire-dans-un-worker">L‚Äôutilisation de la m√©moire dans un worker</h2>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="memoire_worker_1.drawio.png" class="img-fluid"></p>
</div><div class="column" style="width:50%;">
<p><img src="memoire_worker_2.drawio.png" class="img-fluid"></p>
</div>
</div>
<div class="callout-tip callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Ne pas charger plusieurs fois les m√™mes donn√©es en cache, ou si besoin augmenter la part de la m√©moire allou√©e au stockage avec <code>spark.memory.storageFraction</code>.</p>
</div>
</div>
<div class="columns">
<div class="column" style="width:50%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb26-2"><a href="#cb26-2"></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb26-3"><a href="#cb26-3"></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb26-4"><a href="#cb26-4"></a>conf[<span class="st">"spark.memory.fraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb26-5"><a href="#cb26-5"></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb26-6"><a href="#cb26-6"></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb26-7"><a href="#cb26-7"></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb26-8"><a href="#cb26-8"></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb26-9"><a href="#cb26-9"></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb26-10"><a href="#cb26-10"></a></span>
<span id="cb26-11"><a href="#cb26-11"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div><div class="column" style="width:50%;">
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb27-2"><a href="#cb27-2"></a>conf[<span class="st">"spark.driver.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"40Go"</span></span>
<span id="cb27-3"><a href="#cb27-3"></a>conf[<span class="st">"spark.executor.memory"</span>] <span class="ot">&lt;-</span> <span class="st">"80Go"</span></span>
<span id="cb27-4"><a href="#cb27-4"></a>conf[<span class="st">"spark.memory.fraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.8</span></span>
<span id="cb27-5"><a href="#cb27-5"></a>conf[<span class="st">"spark.memory.storageFraction"</span>] <span class="ot">&lt;-</span> <span class="fl">0.4</span></span>
<span id="cb27-6"><a href="#cb27-6"></a>conf[<span class="st">"spark.executor.cores"</span>] <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb27-7"><a href="#cb27-7"></a>conf[<span class="st">"spark.executor.instances"</span>] <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb27-8"><a href="#cb27-8"></a>cont[<span class="st">"spark.yarn.queue"</span>] <span class="ot">&lt;-</span> <span class="st">"prod"</span></span>
<span id="cb27-9"><a href="#cb27-9"></a>conf[<span class="st">"spark.driver.maxResultSize"</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb27-10"><a href="#cb27-10"></a>conf[<span class="st">"spark.sql.shuffle.partitions"</span>] <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb27-11"><a href="#cb27-11"></a></span>
<span id="cb27-12"><a href="#cb27-12"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="sparkui-un-outil-doptimisation" class="level2 smaller scrollable">
<h2 class="smaller scrollable anchored" data-anchor-id="sparkui-un-outil-doptimisation">SparkUI : un outil d‚Äôoptimisation</h2>
<p>Spark UI permet de consulter le plan logique et physique du traitement demand√©. Trois outils permettent d‚Äôoptimiser les traitements :</p>
<div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">DAG</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">GC</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">M√©moire</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<p><img src="dag.webp" class="img-fluid"></p>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<p>V√©rifier que le <code>gc time</code> est inf√©rieur √† 10% du temps pour ex√©cuter la t√¢che ‚úÖ</p>
<p><img src="gc.png" class="img-fluid"></p>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<p>V√©rifier que la <code>storage memory</code> ne sature pas la m√©moire ‚úÖ</p>
<p><img src="gc.png" class="img-fluid"></p>
</div>
</div>
</div>
</section>
<section id="utiliser-les-interfaces" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="utiliser-les-interfaces">Utiliser les interfaces</h2>
<ul>
<li><p><strong>yarn</strong> : disponibilit√© des ressources</p>
<p><img src="yarn_scheduler.PNG" class="img-fluid"></p></li>
<li><p><strong>Sparkhistory</strong> pour des traitements de sessions ferm√©es</p></li>
</ul>
<p>Le sparkhistory entra√Æne l‚Äôenregistrement de logs assez lourdes, il est donc d√©sactiv√© par d√©faut. Pour l‚Äôactiver sur un programme :</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>conf <span class="ot">&lt;-</span> <span class="fu">spark_config</span>()</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.eventLog.enabled"</span>] <span class="ot">&lt;-</span> <span class="st">"true"</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"spark.eventLog.dir"</span>] <span class="ot">&lt;-</span> <span class="st">"hdfs://midares-deb11-nn-01.midares.local:9000/spark-logs"</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>conf[<span class="st">"appName"</span>] <span class="ot">&lt;-</span> <span class="st">"un_nom_de_traitement"</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>sc <span class="ot">&lt;-</span> <span class="fu">spark_connect</span>(<span class="at">master =</span> <span class="st">"yarn"</span>, <span class="at">config =</span> conf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="ma-session-ne-sinstancie-jamais" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="ma-session-ne-sinstancie-jamais">Ma session ne s‚Äôinstancie jamais</h2>
<p>Si l‚Äôinstruction <code>sc &lt;- spark_connect(master = "yarn", config = conf</code> prend plus de 10 minutes, il est utile d‚Äôouvrir l‚Äôinterface de yarn pour v√©rifier que la file n‚Äôest pas d√©j√† enti√®rement occup√©e. L‚Äôerreur peut ne survenir qu‚Äôau bout d‚Äôune vingtaine de minutes : le job est <code>ACCEPTED</code> dans yarn, ou <code>FAILED</code> si la session n‚Äôa pas pu √™tre instanci√©e par manque de ressources disponibles.</p>
<p><img src="yarn_accepted.jpg" class="img-fluid"></p>
</section>
<section id="exporter-de-hdfs-au-local" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="exporter-de-hdfs-au-local">Exporter de HDFS au local</h2>
<div class="r-stack">
<p><img src="hdfs_browse.png" class="fragment" width="1000" height="700"></p>
<p><img src="hdfs_download.png" class="fragment" width="1000" height="700"></p>
</div>
</section>
<section id="pyspark-mode-cluster" class="level2">
<h2 class="anchored" data-anchor-id="pyspark-mode-cluster">Pyspark : mode cluster</h2>
<p><img src="pyspark.drawio.png" class="img-fluid"></p>
</section>
<section id="les-avantages-de-pyspark" class="level2 smaller">
<h2 class="smaller anchored" data-anchor-id="les-avantages-de-pyspark">Les avantages de pyspark</h2>
<ul>
<li><p>Mode cluster : une machine du cluster peut prendre le r√¥le de driver üñ•Ô∏è</p></li>
<li><p>Spark context dans le cluster : fermer sa session anaconda ne stoppe pas le traitement ‚ôæÔ∏è</p></li>
<li><p>Plusieurs sessions simultan√©es üë©‚Äçüíªüë©‚Äçüíªüë©‚Äçüíª</p></li>
<li><p>Stabilit√© : compatibilit√© assur√©e avec Apache Spark, probl√©matique de production üîÑ</p></li>
<li><p>Lisibilit√© du code üëì</p></li>
<li><p>Temps de connexion et d‚Äôex√©cution r√©duit ‚è≤Ô∏è</p></li>
<li><p>Utilisation optimale de SparkUI üìä</p></li>
</ul>
</section>
<section id="merci-pour-votre-attention" class="level2">
<h2 class="anchored" data-anchor-id="merci-pour-votre-attention">Merci pour votre attention !</h2>


</section>
</section>

</main> <!-- /main -->

<script>
  // htmlwidgets need to know to resize themselves when slides are shown/hidden.
  // Fire the "slideenter" event (handled by htmlwidgets.js) when the current
  // slide changes (different for each slide format).
  (function () {
    // dispatch for htmlwidgets
    function fireSlideEnter() {
      const event = window.document.createEvent("Event");
      event.initEvent("slideenter", true, true);
      window.document.dispatchEvent(event);
    }

    function fireSlideChanged(previousSlide, currentSlide) {
      fireSlideEnter();

      // dispatch for shiny
      if (window.jQuery) {
        if (previousSlide) {
          window.jQuery(previousSlide).trigger("hidden");
        }
        if (currentSlide) {
          window.jQuery(currentSlide).trigger("shown");
        }
      }
    }

    // hookup for slidy
    if (window.w3c_slidy) {
      window.w3c_slidy.add_observer(function (slide_num) {
        // slide_num starts at position 1
        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);
      });
    }

  })();
</script>

<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "Óßã";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>